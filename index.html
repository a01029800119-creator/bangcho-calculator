<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>방초매트 발주 계산기 (FM / FM+5%)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="icons/icon-192.png">

  <!-- html2canvas (이미지 저장) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --line:#213252;
      --text:#e8f0ff;
      --muted:#9bb0d1;
      --accent:#4aa3ff;
      --accent2:#7bd35a;
      --danger:#ff6b6b;
      --chip:#0f2448;
      --shadow: 0 10px 28px rgba(0,0,0,.28);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;}
    a{color:var(--accent)}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .topbar{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
    .title h1{margin:0;font-size:22px;letter-spacing:-.2px}
    .title .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{
      border:1px solid var(--line);
      background:#0c1426;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    button.primary{background:var(--accent);border-color:transparent;color:#041022}
    button.ghost{background:transparent}
    button.warn{background:#1a1420;border-color:#3a2230;color:#ffb6c1}
    button:disabled{opacity:.5;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h2{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 980px){ .row2{grid-template-columns:1fr} }

    label{display:block;color:var(--muted);font-size:13px;margin:8px 0 6px}
    input{
      width:100%;
      background:#0c1426;
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
    }
    input:focus{border-color:#355a96}
    .help{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.5}

    /* 모바일 가독성: 재고 입력 라벨 크게 */
    .stockLabel{
      font-size:15px;
      font-weight:800;
      color:#cfe0ff;
      margin-top:10px;
    }
    .stockLabel small{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      margin-left:6px;
    }

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:right;font-size:13px;vertical-align:middle}
    th:first-child,td:first-child{text-align:left}
    th{color:var(--muted);font-weight:800}
    tfoot td{font-weight:900}
    .chip{display:inline-block;background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px;font-weight:800}

    /* 모달 */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
    .modal{width:min(980px, 100%);background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .modalHead{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
    .modalHead .ttl{font-weight:900}
    .modalBody{padding:14px}
    .modalFoot{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid var(--line)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:transparent;color:var(--muted);font-weight:900;font-size:12px;cursor:pointer}
    .tab.on{background:var(--accent);color:#041022;border-color:transparent}
    .adminNote{margin:10px 0 0;color:var(--muted);font-size:12px;line-height:1.5}

    .adminTable{width:100%;border-collapse:collapse}
    .adminTable th,.adminTable td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:13px}
    .adminTable th{color:var(--muted);text-align:left}
    .adminTable td{color:var(--text)}
    .adminTable input{padding:10px;border-radius:10px;font-size:14px}

    /* 출력(A4) */
    .printArea{background:transparent}
    @media print{
      @page{ size: A4; margin: 10mm; }
      body{ background:#fff; color:#000 }
      .wrap{max-width:none;padding:0}
      .topbar, .overlay{display:none !important}
      .card{box-shadow:none;border:1px solid #d0d0d0;background:#fff;color:#000}
      .muted, .chip{color:#333 !important}
      table th{color:#333}
      table th, table td{border-bottom:1px solid #ddd;color:#000}
      .grid{grid-template-columns:1fr 1fr !important;gap:10mm}
      /* A4 1페이지 고정: 불필요한 요소 숨김 */
      .noPrint{display:none !important}
      /* 표 글자 약간 축소 */
      th,td{font-size:11px;padding:7px 6px}
      .card h2{font-size:14px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>방초매트 발주 계산기 <span class="chip">FM · FM+5% 동시</span></h1>
        <div class="sub">
          로그인 없이 사용 가능. <b>단가/설정은 관리자 모드에서만 표시</b>됩니다.
        </div>
      </div>
      <div class="actions">
        <button id="btnAdmin" class="ghost">관리자 설정</button>
        <button id="btnPrint" class="ghost">보고용 출력</button>
        <button id="btnImage" class="ghost">이미지 저장</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>입력</h2>
        <label>공사구간 (m)</label>
        <input id="len" type="number" min="0" step="1" value="1800" />
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button id="btnCalc" class="primary">계산</button>
          <button id="btnReset" class="ghost">기본값 복원</button>
        </div>
        <div class="help">
          · <b>힐티가스</b>: <b>CEIL(힐티핀 필요수량 / 1200)</b> 기준(가스 1캔=약 1200발 기준)<br/>
          · 발주단위 수량(롤/자루/박스/통/캔)은 <b>항상 올림(CEIL)</b> 처리합니다.
        </div>
      </div>

      <div class="card">
        <h2>재고(포장단위) 입력</h2>
        <div class="row2">
          <div>
            <div class="stockLabel">방초매트 <small>(롤)</small></div>
            <input id="stk_mat" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <div class="stockLabel">홀더 <small>(자루)</small></div>
            <input id="stk_holder" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <div class="stockLabel">팩 <small>(자루)</small></div>
            <input id="stk_pack" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <div class="stockLabel">실리콘 <small>(박스)</small></div>
            <input id="stk_sil" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <div class="stockLabel">힐티가스 <small>(캔)</small></div>
            <input id="stk_gas" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <div class="stockLabel">힐티핀 <small>(통)</small></div>
            <input id="stk_pin" type="number" min="0" step="1" value="0" />
          </div>
        </div>
        <div class="help">
          * 재고는 “포장단위(롤/자루/박스/통/캔)” 기준입니다.
        </div>
      </div>
    </div>

    <div class="grid printArea" id="printArea" style="margin-top:12px">
      <div class="card">
        <h2>FM 결과</h2>
        <div class="noPrint muted" id="authHint1" style="display:none;margin-top:-6px">※ 단가/금액은 관리자 모드에서만 표시됩니다.</div>
        <div id="tbl_fm"></div>
      </div>

      <div class="card">
        <h2>FM+5% 결과</h2>
        <div class="noPrint muted" id="authHint2" style="display:none;margin-top:-6px">※ 단가/금액은 관리자 모드에서만 표시됩니다.</div>
        <div id="tbl_fm5"></div>
      </div>
    </div>
  </div>

  <!-- 관리자 모달 -->
  <div class="overlay" id="ov">
    <div class="modal">
      <div class="modalHead">
        <div class="ttl">관리자 설정</div>
        <div class="tabs">
          <button class="tab on" data-tab="price">단가(VAT)</button>
          <button class="tab" data-tab="pack">포장수량</button>
          <button class="tab" data-tab="coef">계수(1m당)</button>
          <button class="tab" data-tab="sec">보안</button>
          <button class="tab" id="btnClose">닫기</button>
        </div>
      </div>
      <div class="modalBody">
        <div id="panel_price"></div>
        <div id="panel_pack" style="display:none"></div>
        <div id="panel_coef" style="display:none"></div>
        <div id="panel_sec" style="display:none"></div>

        <div class="adminNote">
          · 배포용 기본값은 이미 맞춰두었습니다. (실리콘 25개/박스, 힐티핀 1200발/통 등)<br/>
          · 단가/금액은 <b>관리자 인증(비번)</b>이 되어야 표에 표시됩니다.
        </div>
      </div>
      <div class="modalFoot">
        <button id="btnSaveAdmin" class="primary">저장</button>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  기본 설정(배포용 고정값)
 *  ========================= */
const DEFAULT_CFG = {
  adminPass: "1004",
  // 1m당 소요 계수 (기본 FM 기준)
  coef: {
    mat_m_per_m: 1.0,              // 방초매트: 1m당 1m
    holder_per_m: 1/3,             // 홀더: 1m당 0.3333개 (3m당 1개)
    pack_per_m: 3.0,               // 팩: 1m당 3개
    silicone_per_m: 0.2,           // 실리콘: 1m당 0.2개
    pin_per_m: 4.0                 // 힐티핀: 1m당 4발
    // 힐티가스는 핀 기준으로 산출 (아래 계산식)
  },
  // 포장수량 (발주단위 1개에 포함되는 "기본단위" 수량)
  pack: {
    mat_m_per_roll: 50,            // 1롤 = 50m
    holder_per_bag: 500,           // 1자루 = 500개
    pack_per_bag: 500,             // 1자루 = 500개
    silicone_per_box: 25,          // 1박스 = 25개  ✅(중요)
    pin_per_tong: 1200             // 1통 = 1200발 ✅(중요)
    // gas_per_can = 1 (고정)
  },
  // 단가(VAT 포함) - "기본단위" 기준
  // 방초매트: 1m당, 홀더/팩/실리콘: 1개당, 힐티핀: 1통당(1200발), 힐티가스: 1캔당
  price: {
    mat_per_m: 3960,
    holder_per_ea: 715,
    pack_per_ea: 330,
    silicone_per_ea: 1700,
    gas_per_can: 80850,
    pin_per_tong: 51150
  }
};

const KEY_CFG = "bangcho_cfg_v3";
const KEY_AUTH = "bangcho_admin_auth_v3";

function loadCfg(){
  const raw = localStorage.getItem(KEY_CFG);
  if(!raw) return structuredClone(DEFAULT_CFG);
  try{
    const obj = JSON.parse(raw);
    // 누락 필드 보정
    return {
      ...structuredClone(DEFAULT_CFG),
      ...obj,
      coef: {...structuredClone(DEFAULT_CFG.coef), ...(obj.coef||{})},
      pack: {...structuredClone(DEFAULT_CFG.pack), ...(obj.pack||{})},
      price:{...structuredClone(DEFAULT_CFG.price),...(obj.price||{})}
    };
  }catch(e){
    return structuredClone(DEFAULT_CFG);
  }
}
function saveCfg(cfg){
  localStorage.setItem(KEY_CFG, JSON.stringify(cfg));
}

function isAdmin(){
  return localStorage.getItem(KEY_AUTH) === "1";
}

function requireAdmin(){
  const cfg = loadCfg();
  const pw = prompt("관리자 비밀번호를 입력하세요.");
  if(pw === null) return false;
  if(String(pw) === String(cfg.adminPass)){
    localStorage.setItem(KEY_AUTH,"1");
    return true;
  }
  alert("비밀번호가 올바르지 않습니다.");
  return false;
}

function money(n){
  const x = Number(n);
  if(!isFinite(x)) return "";
  return x.toLocaleString("ko-KR") + "원";
}

function ceil(n){ return Math.ceil(Number(n)); }
function max0(n){ return Math.max(0, Number(n)); }

function readStocks(){
  return {
    mat_roll: Number(document.getElementById("stk_mat").value||0),
    holder_bag: Number(document.getElementById("stk_holder").value||0),
    pack_bag: Number(document.getElementById("stk_pack").value||0),
    silicone_box: Number(document.getElementById("stk_sil").value||0),
    gas_can: Number(document.getElementById("stk_gas").value||0),
    pin_tong: Number(document.getElementById("stk_pin").value||0)
  };
}

/** =========================
 *  핵심 계산 로직 (오류 수정본)
 *  =========================
 *  - 기본단위 필요수량 산출
 *  - 발주단위(포장단위) 필요수량 = CEIL(필요 / 포장수량)
 *  - 추가발주(발주단위) = MAX(0, 필요발주단위 - 재고발주단위)
 *  - 추가발주 금액은 "추가발주 기본단위 환산값" 기준으로 계산 (기존 화면과 동일)
 */
function compute(lenM, factor){
  const cfg = loadCfg();
  const st = readStocks();

  const L = Number(lenM||0) * Number(factor||1);

  // 기본단위 필요수량(소수 가능)
  const need = {
    mat_m: L * cfg.coef.mat_m_per_m,
    holder_ea: L * cfg.coef.holder_per_m,
    pack_ea: L * cfg.coef.pack_per_m,
    silicone_ea: L * cfg.coef.silicone_per_m,
    pin_ea: L * cfg.coef.pin_per_m
  };

  // 힐티가스: 핀 기반 (1200발당 1캔)
  const needGasCan = ceil(need.pin_ea / cfg.pack.pin_per_tong); // pin_per_tong = 1200
  // 핀은 "발"로 필요수량 표시하되, 발주단위는 '통(1200발)'로 환산
  const needPinTong = ceil(need.pin_ea / cfg.pack.pin_per_tong);

  // 발주단위 필요수량(올림)
  const req = {
    mat_roll: ceil(need.mat_m / cfg.pack.mat_m_per_roll),
    holder_bag: ceil(need.holder_ea / cfg.pack.holder_per_bag),
    pack_bag: ceil(need.pack_ea / cfg.pack.pack_per_bag),
    silicone_box: ceil(need.silicone_ea / cfg.pack.silicone_per_box),
    gas_can: needGasCan,
    pin_tong: needPinTong
  };

  // 추가발주(발주단위)
  const add = {
    mat_roll: max0(req.mat_roll - st.mat_roll),
    holder_bag: max0(req.holder_bag - st.holder_bag),
    pack_bag: max0(req.pack_bag - st.pack_bag),
    silicone_box: max0(req.silicone_box - st.silicone_box),
    gas_can: max0(req.gas_can - st.gas_can),
    pin_tong: max0(req.pin_tong - st.pin_tong)
  };

  // 추가발주를 "기본단위"로 환산(금액용)
  const addBase = {
    mat_m: add.mat_roll * cfg.pack.mat_m_per_roll,
    holder_ea: add.holder_bag * cfg.pack.holder_per_bag,
    pack_ea: add.pack_bag * cfg.pack.pack_per_bag,
    silicone_ea: add.silicone_box * cfg.pack.silicone_per_box,
    gas_can: add.gas_can * 1,
    pin_tong: add.pin_tong * 1
  };

  // 필요금액(기본단위 기준 / 핀은 통 기준 / 가스는 캔 기준)
  const amtNeed = {
    mat: need.mat_m * cfg.price.mat_per_m,
    holder: need.holder_ea * cfg.price.holder_per_ea,
    pack: need.pack_ea * cfg.price.pack_per_ea,
    silicone: need.silicone_ea * cfg.price.silicone_per_ea,
    gas: req.gas_can * cfg.price.gas_per_can,
    pin: req.pin_tong * cfg.price.pin_per_tong
  };

  // 추가발주금액
  const amtAdd = {
    mat: addBase.mat_m * cfg.price.mat_per_m,
    holder: addBase.holder_ea * cfg.price.holder_per_ea,
    pack: addBase.pack_ea * cfg.price.pack_per_ea,
    silicone: addBase.silicone_ea * cfg.price.silicone_per_ea,
    gas: add.gas_can * cfg.price.gas_per_can,
    pin: add.pin_tong * cfg.price.pin_per_tong
  };

  // 표시용(필요수량 소수는 2자리)
  const view = {
    need: {
      mat_m: need.mat_m,
      holder_ea: need.holder_ea,
      pack_ea: need.pack_ea,
      silicone_ea: need.silicone_ea,
      gas_can: req.gas_can,     // 가스는 최종 캔 수(정수)
      pin_ea: need.pin_ea
    },
    req, st, add, amtNeed, amtAdd
  };

  return view;
}

function renderTable(targetId, data){
  const cfg = loadCfg();
  const admin = isAdmin();

  if(!admin){
    document.getElementById("authHint1").style.display = "block";
    document.getElementById("authHint2").style.display = "block";
  }else{
    document.getElementById("authHint1").style.display = "none";
    document.getElementById("authHint2").style.display = "none";
  }

  const rows = [
    {
      name:"방초매트",
      need: data.need.mat_m, needUnit:"m",
      orderUnit:"롤", unitQty: data.req.mat_roll, stock: data.st.mat_roll, add: data.add.mat_roll,
      price: cfg.price.mat_per_m, priceUnit:"/m",
      needAmt: data.amtNeed.mat, addAmt: data.amtAdd.mat
    },
    {
      name:"홀더",
      need: data.need.holder_ea, needUnit:"개",
      orderUnit:"자루", unitQty: data.req.holder_bag, stock: data.st.holder_bag, add: data.add.holder_bag,
      price: cfg.price.holder_per_ea, priceUnit:"/개",
      needAmt: data.amtNeed.holder, addAmt: data.amtAdd.holder
    },
    {
      name:"팩",
      need: data.need.pack_ea, needUnit:"개",
      orderUnit:"자루", unitQty: data.req.pack_bag, stock: data.st.pack_bag, add: data.add.pack_bag,
      price: cfg.price.pack_per_ea, priceUnit:"/개",
      needAmt: data.amtNeed.pack, addAmt: data.amtAdd.pack
    },
    {
      name:"실리콘",
      need: data.need.silicone_ea, needUnit:"개",
      orderUnit:"박스", unitQty: data.req.silicone_box, stock: data.st.silicone_box, add: data.add.silicone_box,
      price: cfg.price.silicone_per_ea, priceUnit:"/개",
      needAmt: data.amtNeed.silicone, addAmt: data.amtAdd.silicone
    },
    {
      name:"힐티가스",
      need: data.need.gas_can, needUnit:"캔",
      orderUnit:"캔", unitQty: data.req.gas_can, stock: data.st.gas_can, add: data.add.gas_can,
      price: cfg.price.gas_per_can, priceUnit:"/캔",
      needAmt: data.amtNeed.gas, addAmt: data.amtAdd.gas
    },
    {
      name:"힐티핀",
      need: data.need.pin_ea, needUnit:"발",
      orderUnit:"통", unitQty: data.req.pin_tong, stock: data.st.pin_tong, add: data.add.pin_tong,
      price: cfg.price.pin_per_tong, priceUnit:"/통(1200발)",
      needAmt: data.amtNeed.pin, addAmt: data.amtAdd.pin
    },
  ];

  const sumNeed = rows.reduce((a,r)=>a+(admin?Number(r.needAmt):0),0);
  const sumAdd  = rows.reduce((a,r)=>a+(admin?Number(r.addAmt):0),0);

  const html = `
    <table>
      <thead>
        <tr>
          <th>자재</th>
          <th>필요수량</th>
          <th>단위</th>
          <th>발주단위</th>
          <th>단위수량</th>
          <th>재고</th>
          <th>추가발주</th>
          <th>${admin ? "단가(VAT)" : "단가"}</th>
          <th>${admin ? "필요금액" : "필요금액"}</th>
          <th>${admin ? "추가발주금액" : "추가발주금액"}</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>{
          const needVal = (r.needUnit==="캔") ? String(r.need) : (Number(r.need).toFixed(2).replace(/\.00$/,''));
          const priceStr = admin ? `${Number(r.price).toLocaleString("ko-KR")}${r.priceUnit}` : "-";
          const needAmt = admin ? money(r.needAmt) : "-";
          const addAmt  = admin ? money(r.addAmt)  : "-";
          return `
          <tr>
            <td style="font-weight:900">${r.name}</td>
            <td>${needVal}</td>
            <td>${r.needUnit}</td>
            <td>${r.orderUnit}</td>
            <td>${Number(r.unitQty).toLocaleString("ko-KR")}</td>
            <td>${Number(r.stock).toLocaleString("ko-KR")}</td>
            <td style="font-weight:900">${Number(r.add).toLocaleString("ko-KR")}</td>
            <td>${priceStr}</td>
            <td style="font-weight:900">${needAmt}</td>
            <td style="font-weight:900">${addAmt}</td>
          </tr>`;
        }).join("")}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="8" style="text-align:left">합계</td>
          <td style="font-weight:900">${admin ? money(sumNeed) : "-"}</td>
          <td style="font-weight:900">${admin ? money(sumAdd) : "-"}</td>
        </tr>
      </tfoot>
    </table>
  `;
  document.getElementById(targetId).innerHTML = html;
}

/** =========================
 *  관리자 UI
 *  ========================= */
function adminPanelHTML(cfg, mode){
  const isPrice = mode==="price";
  const isPack  = mode==="pack";
  const isCoef  = mode==="coef";
  const isSec   = mode==="sec";

  if(isPrice){
    return `
      <table class="adminTable">
        <thead><tr><th style="width:160px">자재</th><th>단가(VAT)</th><th style="width:160px">기준</th></tr></thead>
        <tbody>
          <tr><th>방초매트</th><td><input id="p_mat" type="number" value="${cfg.price.mat_per_m}"></td><td>/m</td></tr>
          <tr><th>홀더</th><td><input id="p_holder" type="number" value="${cfg.price.holder_per_ea}"></td><td>/개</td></tr>
          <tr><th>팩</th><td><input id="p_pack" type="number" value="${cfg.price.pack_per_ea}"></td><td>/개</td></tr>
          <tr><th>실리콘</th><td><input id="p_sil" type="number" value="${cfg.price.silicone_per_ea}"></td><td>/개</td></tr>
          <tr><th>힐티가스</th><td><input id="p_gas" type="number" value="${cfg.price.gas_per_can}"></td><td>/캔</td></tr>
          <tr><th>힐티핀</th><td><input id="p_pin" type="number" value="${cfg.price.pin_per_tong}"></td><td>/통(1200발)</td></tr>
        </tbody>
      </table>
    `;
  }
  if(isPack){
    return `
      <table class="adminTable">
        <thead><tr><th style="width:160px">자재</th><th>포장수량</th><th style="width:160px">설명</th></tr></thead>
        <tbody>
          <tr><th>방초매트</th><td><input id="pk_mat" type="number" value="${cfg.pack.mat_m_per_roll}"></td><td>m / 롤</td></tr>
          <tr><th>홀더</th><td><input id="pk_holder" type="number" value="${cfg.pack.holder_per_bag}"></td><td>개 / 자루</td></tr>
          <tr><th>팩</th><td><input id="pk_pack" type="number" value="${cfg.pack.pack_per_bag}"></td><td>개 / 자루</td></tr>
          <tr><th>실리콘</th><td><input id="pk_sil" type="number" value="${cfg.pack.silicone_per_box}"></td><td>개 / 박스</td></tr>
          <tr><th>힐티핀</th><td><input id="pk_pin" type="number" value="${cfg.pack.pin_per_tong}"></td><td>발 / 통</td></tr>
        </tbody>
      </table>
    `;
  }
  if(isCoef){
    return `
      <table class="adminTable">
        <thead><tr><th style="width:160px">항목</th><th>계수</th><th style="width:220px">설명</th></tr></thead>
        <tbody>
          <tr><th>홀더</th><td><input id="c_holder" type="number" step="0.0001" value="${cfg.coef.holder_per_m}"></td><td>1m당 필요 개수</td></tr>
          <tr><th>팩</th><td><input id="c_pack" type="number" step="0.0001" value="${cfg.coef.pack_per_m}"></td><td>1m당 필요 개수</td></tr>
          <tr><th>실리콘</th><td><input id="c_sil" type="number" step="0.0001" value="${cfg.coef.silicone_per_m}"></td><td>1m당 필요 개수</td></tr>
          <tr><th>힐티핀</th><td><input id="c_pin" type="number" step="0.0001" value="${cfg.coef.pin_per_m}"></td><td>1m당 필요 발</td></tr>
        </tbody>
      </table>
      <div class="adminNote">※ 힐티가스는 “핀/1200” 기준 자동 계산입니다.</div>
    `;
  }
  if(isSec){
    return `
      <div class="card" style="box-shadow:none">
        <h2 style="margin:0 0 10px 0">보안</h2>
        <div class="muted" style="margin-bottom:10px">
          현재 설정: <b>${isAdmin() ? "관리자 인증됨(단가 표시)" : "일반모드(단가 숨김)"}</b>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnAuthNow" class="primary">관리자 인증</button>
          <button id="btnLogout" class="warn">관리자 해제</button>
        </div>
        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
        <label>관리자 비밀번호 변경</label>
        <input id="newPass" placeholder="새 비밀번호" />
        <div class="help">※ 비밀번호는 로컬스토리지에 저장됩니다(이 브라우저/기기 기준).</div>
      </div>
    `;
  }
  return "";
}

function openAdmin(){
  // 관리자 설정 열기 전에 인증 요구(단, 읽기만 열고 단가 숨김 유지도 가능)
  document.getElementById("ov").style.display = "flex";
  const cfg = loadCfg();
  document.getElementById("panel_price").innerHTML = adminPanelHTML(cfg,"price");
  document.getElementById("panel_pack").innerHTML  = adminPanelHTML(cfg,"pack");
  document.getElementById("panel_coef").innerHTML  = adminPanelHTML(cfg,"coef");
  document.getElementById("panel_sec").innerHTML   = adminPanelHTML(cfg,"sec");

  // 보안 탭 버튼 이벤트 (동적 생성이라 여기서 연결)
  setTimeout(()=>{
    const btnAuthNow = document.getElementById("btnAuthNow");
    if(btnAuthNow){
      btnAuthNow.onclick = ()=>{
        if(requireAdmin()){
          alert("관리자 인증 완료. 단가/금액이 표시됩니다.");
          recalc();
          openAdmin(); // 패널 갱신
        }
      };
    }
    const btnLogout = document.getElementById("btnLogout");
    if(btnLogout){
      btnLogout.onclick = ()=>{
        localStorage.removeItem(KEY_AUTH);
        alert("관리자 해제 완료. 단가/금액이 숨김 처리됩니다.");
        recalc();
        openAdmin();
      };
    }
  }, 0);
}

function closeAdmin(){
  document.getElementById("ov").style.display = "none";
}

function switchTab(tab){
  const tabs = document.querySelectorAll(".tab[data-tab]");
  tabs.forEach(t=>t.classList.toggle("on", t.dataset.tab===tab));
  document.getElementById("panel_price").style.display = (tab==="price") ? "block" : "none";
  document.getElementById("panel_pack").style.display  = (tab==="pack")  ? "block" : "none";
  document.getElementById("panel_coef").style.display  = (tab==="coef")  ? "block" : "none";
  document.getElementById("panel_sec").style.display   = (tab==="sec")   ? "block" : "none";
}

/** =========================
 *  계산/출력/이미지
 *  ========================= */
function recalc(){
  const lenM = Number(document.getElementById("len").value||0);
  const fm  = compute(lenM, 1.0);
  const fm5 = compute(lenM, 1.05);
  renderTable("tbl_fm", fm);
  renderTable("tbl_fm5", fm5);
}

async function saveImage(){
  const node = document.getElementById("printArea");
  const canvas = await html2canvas(node, {backgroundColor: null, scale: 2});
  const a = document.createElement("a");
  a.download = "bangcho-report.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
}

function doPrint(){
  window.print();
}

/** =========================
 *  이벤트 바인딩
 *  ========================= */
document.getElementById("btnCalc").onclick = recalc;

document.getElementById("btnReset").onclick = ()=>{
  if(confirm("기본값으로 복원할까요? (단가/설정/보안 포함)")){
    localStorage.removeItem(KEY_CFG);
    localStorage.removeItem(KEY_AUTH);
    alert("기본값으로 복원했습니다.");
    recalc();
  }
};

document.getElementById("btnAdmin").onclick = ()=>{
  openAdmin();
};

document.getElementById("btnClose").onclick = closeAdmin;
document.getElementById("ov").addEventListener("click", (e)=>{
  if(e.target.id==="ov") closeAdmin();
});

document.querySelectorAll(".tab[data-tab]").forEach(btn=>{
  btn.addEventListener("click", ()=>switchTab(btn.dataset.tab));
});

document.getElementById("btnSaveAdmin").onclick = ()=>{
  const cfg = loadCfg();

  // price
  if(document.getElementById("p_mat")){
    cfg.price.mat_per_m = Number(document.getElementById("p_mat").value||cfg.price.mat_per_m);
    cfg.price.holder_per_ea = Number(document.getElementById("p_holder").value||cfg.price.holder_per_ea);
    cfg.price.pack_per_ea = Number(document.getElementById("p_pack").value||cfg.price.pack_per_ea);
    cfg.price.silicone_per_ea = Number(document.getElementById("p_sil").value||cfg.price.silicone_per_ea);
    cfg.price.gas_per_can = Number(document.getElementById("p_gas").value||cfg.price.gas_per_can);
    cfg.price.pin_per_tong = Number(document.getElementById("p_pin").value||cfg.price.pin_per_tong);
  }

  // pack
  if(document.getElementById("pk_mat")){
    cfg.pack.mat_m_per_roll = Number(document.getElementById("pk_mat").value||cfg.pack.mat_m_per_roll);
    cfg.pack.holder_per_bag = Number(document.getElementById("pk_holder").value||cfg.pack.holder_per_bag);
    cfg.pack.pack_per_bag = Number(document.getElementById("pk_pack").value||cfg.pack.pack_per_bag);
    cfg.pack.silicone_per_box = Number(document.getElementById("pk_sil").value||cfg.pack.silicone_per_box);
    cfg.pack.pin_per_tong = Number(document.getElementById("pk_pin").value||cfg.pack.pin_per_tong);
  }

  // coef
  if(document.getElementById("c_holder")){
    cfg.coef.holder_per_m = Number(document.getElementById("c_holder").value||cfg.coef.holder_per_m);
    cfg.coef.pack_per_m = Number(document.getElementById("c_pack").value||cfg.coef.pack_per_m);
    cfg.coef.silicone_per_m = Number(document.getElementById("c_sil").value||cfg.coef.silicone_per_m);
    cfg.coef.pin_per_m = Number(document.getElementById("c_pin").value||cfg.coef.pin_per_m);
  }

  // security
  const newPass = document.getElementById("newPass");
  if(newPass && String(newPass.value||"").trim()){
    cfg.adminPass = String(newPass.value).trim();
  }

  saveCfg(cfg);
  alert("저장 완료");
  recalc();
  closeAdmin();
};

document.getElementById("btnPrint").onclick = doPrint;
document.getElementById("btnImage").onclick = saveImage;

// 재고 입력 변경 시 즉시 재계산
["stk_mat","stk_holder","stk_pack","stk_sil","stk_gas","stk_pin","len"].forEach(id=>{
  document.getElementById(id).addEventListener("input", ()=>{
    // 너무 잦은 렌더 방지(간단 디바운스)
    clearTimeout(window.__t);
    window.__t = setTimeout(recalc, 150);
  });
});

// 최초 로드
window.addEventListener("load", ()=>{
  recalc();
});
</script>
</body>
</html>
