<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>방초매트 발주 계산기 (FM / FM+5%)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- html2canvas (이미지 저장) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#101a2f; --line:#213252;
      --text:#e8f0ff; --muted:#9bb0d1; --accent:#44a3ff;
      --shadow: 0 10px 25px rgba(0,0,0,.35); --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    .pill{display:inline-block;border:1px solid var(--line);background:rgba(15,36,72,.55);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{border:1px solid var(--line);background:#0c1426;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:#041022;font-weight:800}
    button:active{transform:translateY(1px)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px 0;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:900px){ .row{grid-template-columns:1fr} }
    label{display:block;color:var(--muted);font-size:13px;margin:8px 0 6px}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1426;color:var(--text);font-size:15px}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.45}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:right;font-size:13px}
    th:first-child,td:first-child{text-align:left}
    th{color:var(--muted);font-weight:700}
    tfoot td{font-weight:900}
    .money{font-variant-numeric:tabular-nums}

    /* ✅ 모바일 가독성 강화: 재고 입력 라벨(자재명+단위) 크게 */
    .stock label{font-size:14px;font-weight:800;color:var(--text);letter-spacing:.1px}
    .stock label span.unit{color:var(--muted);font-weight:700;margin-left:6px}
    @media(max-width:600px){
      .stock label{font-size:18px}
      .stock input{font-size:16px;padding:12px 12px}
    }

    /* 단가숨김(B): 기본 숨김, 관리자에서만 표시 */
    .price-col{display:none}
    .show-prices .price-col{display:table-cell}

    .print-area{margin-top:12px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){ .two-col{grid-template-columns:1fr} }

    /* ✅ A4 1페이지 출력 고정 */
    @page { size: A4; margin: 10mm; }
    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:none;padding:0}
      .topbar,.toolbar,.input-area,.hint,.btnrow{display:none !important}
      .card{box-shadow:none;border:1px solid #ccc;background:#fff;color:#000}
      .pill{display:none}
      .print-area{margin:0}
      .two-col{grid-template-columns:1fr 1fr;gap:8mm}
      table{margin-top:6mm}
      th,td{font-size:10.5pt;padding:6px 5px;border-bottom:1px solid #ddd}
      h2{font-size:12pt;margin:0 0 4mm 0}
      .no-break{page-break-inside:avoid;break-inside:avoid}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <div style="display:flex;align-items:center;gap:10px">
        <h1>방초매트 발주 계산기</h1>
        <span class="pill">FM · FM+5% 동시</span>
      </div>
      <div class="sub">로그인 없이 사용 가능. <b>단가/설정은 관리자 모드에서만 표시</b>됩니다.</div>
    </div>

    <div class="toolbar">
      <button id="btnAdmin">관리자 설정</button>
      <button id="btnPrint">보고용 출력</button>
      <button id="btnSaveImg">이미지 저장</button>
    </div>
  </div>

  <div class="grid input-area">
    <div class="card">
      <h2>입력</h2>

      <label for="len">공사구간 (m)</label>
      <input id="len" type="number" inputmode="numeric" value="1800" min="0"/>

      <div class="btnrow">
        <button class="primary" id="btnCalc">계산</button>
        <button id="btnReset">기본값 복원</button>
      </div>

      <div class="hint">
        · 발주단위(롤/자루/박스/통)는 <b>올림</b> 처리합니다.<br>
        · 힐티핀은 <b>1통=1200발</b> 기준입니다.
      </div>
    </div>

    <div class="card stock">
      <h2>재고(발주단위) 입력</h2>
      <div class="row" id="stockInputs"></div>
      <div class="hint">* 재고는 “발주단위(롤/자루/박스/캔/통)” 기준입니다.</div>
    </div>
  </div>

  <div class="print-area" id="printArea">
    <div class="two-col">
      <div class="card no-break">
        <h2>FM 결과</h2>
        <div id="outFM"></div>
      </div>
      <div class="card no-break">
        <h2>FM+5% 결과</h2>
        <div id="outFM5"></div>
      </div>
    </div>
  </div>

</div>

<script>
/** ✅ 최초1회 비번(1004) */
const FIRST_PASS = "1004";
const KEY_UNLOCK = "bangcho_unlocked_once";
(function firstTimeGate(){
  const unlocked = localStorage.getItem(KEY_UNLOCK) === "1";
  if (unlocked) return;
  const pw = prompt("최초 1회 실행 비밀번호를 입력하세요:");
  if (pw !== FIRST_PASS) {
    alert("비밀번호가 올바르지 않습니다. (새로고침 후 다시 입력)");
    document.body.innerHTML = "";
    return;
  }
  localStorage.setItem(KEY_UNLOCK, "1");
})();

/**
 * ✅ 여기 기본값이 “기존 결과(1300m 테스트)”랑 맞게 잡혀 있습니다.
 * - 방초: 1롤=50m, 단가= m당
 * - 홀더: 1자루=50개, 단가= 개당
 * - 팩: 1자루=500개, 단가= 개당
 * - 실리콘: 1박스=25개, 단가= 개당
 * - 힐티핀: 1통=1200발, 단가= 통당 입력(계산은 발당=통단가/1200)
 */
const DEFAULT_CFG = {
  prices_base: { // ✅ 기본단위 단가(원)
    mat_per_m: 3960,      // m당
    holder_per_each: 715, // 개당
    peg_per_each: 330,    // 개당
    silicone_per_each: 1700, // 개당
    hiltiGas_per_can: 80850, // 캔당
    hiltiPin_per_tong: 51150 // 통당(내부 계산은 /1200 해서 발당)
  },
  pack: { // ✅ 1발주단위에 들어있는 기본단위 수량
    mat_m_per_roll: 50,
    holder_each_per_bag: 50,
    peg_each_per_bag: 500,
    silicone_each_per_box: 25,
    hiltiGas_can_per_can: 1,
    hiltiPin_shot_per_tong: 1200
  },
  rules: { // ✅ 1m당 필요수량 (기본단위 기준)
    mat_m_per_m: 1.0,                 // 1m당 방초 1m
    holder_each_per_m: 0.3330769231,  // 1300m -> 433개
    peg_each_per_m: 3.0,              // 1300m -> 3900개
    silicone_each_per_m: 0.2,         // 1300m -> 260개
    hiltiGas_can_per_m: 0.0038461538, // 1300m -> 5캔
    hiltiPin_shot_per_m: 4.0          // 1300m -> 5200발
  }
};

const KEY_CFG = "bangcho_cfg_v2"; // ✅ 버전 올려서 기존 꼬인 설정과 분리
function loadCfg(){
  try{
    const raw = localStorage.getItem(KEY_CFG);
    if(!raw) return structuredClone(DEFAULT_CFG);
    const obj = JSON.parse(raw);
    return {
      ...structuredClone(DEFAULT_CFG),
      ...obj,
      prices_base:{...DEFAULT_CFG.prices_base, ...(obj.prices_base||{})},
      pack:{...DEFAULT_CFG.pack, ...(obj.pack||{})},
      rules:{...DEFAULT_CFG.rules, ...(obj.rules||{})}
    };
  }catch(e){ return structuredClone(DEFAULT_CFG); }
}
function saveCfg(cfg){ localStorage.setItem(KEY_CFG, JSON.stringify(cfg)); }
let cfg = loadCfg();

function ceil(n){ return Math.ceil(Number(n)); }
function clamp0(n){ return Math.max(0, Number(n||0)); }
function money(n){ return Number(n||0).toLocaleString("ko-KR"); }

const MATERIALS = [
  { key:"mat", name:"방초매트", stockUnit:"롤", baseUnit:"m" },
  { key:"holder", name:"홀더", stockUnit:"자루", baseUnit:"개" },
  { key:"peg", name:"팩", stockUnit:"자루", baseUnit:"개" },
  { key:"silicone", name:"실리콘", stockUnit:"박스", baseUnit:"개" },
  { key:"hiltiGas", name:"힐티가스", stockUnit:"캔", baseUnit:"캔" },
  { key:"hiltiPin", name:"힐티핀", stockUnit:"통", baseUnit:"발" }
];

// 재고는 “발주단위” 기준
const stockState = { mat:0, holder:0, peg:0, silicone:0, hiltiGas:0, hiltiPin:0 };

function renderStockInputs(){
  const wrap = document.getElementById("stockInputs");
  wrap.innerHTML = "";
  for(const m of MATERIALS){
    const div = document.createElement("div");
    div.innerHTML = `
      <label for="st_${m.key}">${m.name}<span class="unit">(${m.stockUnit})</span></label>
      <input id="st_${m.key}" type="number" inputmode="numeric" min="0" value="${stockState[m.key]||0}">
    `;
    wrap.appendChild(div);
    div.querySelector("input").addEventListener("input", (e)=>{
      stockState[m.key] = Number(e.target.value||0);
    });
  }
}

function computeNeedBase(len, mult){
  const r = cfg.rules;
  return {
    mat_m: len * r.mat_m_per_m * mult,
    holder_each: len * r.holder_each_per_m * mult,
    peg_each: len * r.peg_each_per_m * mult,
    silicone_each: len * r.silicone_each_per_m * mult,
    hiltiGas_can: len * r.hiltiGas_can_per_m * mult,
    hiltiPin_shot: len * r.hiltiPin_shot_per_m * mult
  };
}

// 발주단위(올림) 계산
function computeOrderUnits(need){
  const p = cfg.pack;
  return {
    mat_roll: ceil(need.mat_m / p.mat_m_per_roll),
    holder_bag: ceil(need.holder_each / p.holder_each_per_bag),
    peg_bag: ceil(need.peg_each / p.peg_each_per_bag),
    silicone_box: ceil(need.silicone_each / p.silicone_each_per_box),
    hiltiGas_can: ceil(need.hiltiGas_can / p.hiltiGas_can_per_can),
    hiltiPin_tong: ceil(need.hiltiPin_shot / p.hiltiPin_shot_per_tong)
  };
}

// 추가발주(발주단위) 계산
function computeAddUnits(order){
  return {
    mat_roll: Math.max(0, order.mat_roll - clamp0(stockState.mat)),
    holder_bag: Math.max(0, order.holder_bag - clamp0(stockState.holder)),
    peg_bag: Math.max(0, order.peg_bag - clamp0(stockState.peg)),
    silicone_box: Math.max(0, order.silicone_box - clamp0(stockState.silicone)),
    hiltiGas_can: Math.max(0, order.hiltiGas_can - clamp0(stockState.hiltiGas)),
    hiltiPin_tong: Math.max(0, order.hiltiPin_tong - clamp0(stockState.hiltiPin))
  };
}

// 발주단위를 기본단위로 환산(추가발주 금액 계산용)
function addBaseFromAddUnits(add){
  const p = cfg.pack;
  return {
    mat_m: add.mat_roll * p.mat_m_per_roll,
    holder_each: add.holder_bag * p.holder_each_per_bag,
    peg_each: add.peg_bag * p.peg_each_per_bag,
    silicone_each: add.silicone_box * p.silicone_each_per_box,
    hiltiGas_can: add.hiltiGas_can * p.hiltiGas_can_per_can,
    hiltiPin_shot: add.hiltiPin_tong * p.hiltiPin_shot_per_tong
  };
}

// ✅ 금액: 기본단위 기준으로 계산(원래 방식 복원)
function computeMoney(needBase, addBase){
  const u = cfg.prices_base;
  const hiltiPin_per_shot = u.hiltiPin_per_tong / cfg.pack.hiltiPin_shot_per_tong; // 발당 단가

  const needAmt = {
    mat: needBase.mat_m * u.mat_per_m,
    holder: needBase.holder_each * u.holder_per_each,
    peg: needBase.peg_each * u.peg_per_each,
    silicone: needBase.silicone_each * u.silicone_per_each,
    hiltiGas: needBase.hiltiGas_can * u.hiltiGas_per_can,
    hiltiPin: needBase.hiltiPin_shot * hiltiPin_per_shot
  };
  const addAmt = {
    mat: addBase.mat_m * u.mat_per_m,
    holder: addBase.holder_each * u.holder_per_each,
    peg: addBase.peg_each * u.peg_per_each,
    silicone: addBase.silicone_each * u.silicone_per_each,
    hiltiGas: addBase.hiltiGas_can * u.hiltiGas_per_can,
    hiltiPin: addBase.hiltiPin_shot * hiltiPin_per_shot
  };
  return { needAmt, addAmt, hiltiPin_per_shot };
}

function renderTable(mult, targetId){
  const len = clamp0(document.getElementById("len").value);
  const need = computeNeedBase(len, mult);
  const order = computeOrderUnits(need);
  const add = computeAddUnits(order);
  const addBase = addBaseFromAddUnits(add);
  const { needAmt, addAmt, hiltiPin_per_shot } = computeMoney(need, addBase);

  const showPrices = document.body.classList.contains("show-prices");
  const u = cfg.prices_base;

  const rows = [
    {
      name:"방초매트", needQty:need.mat_m, baseUnit:"m",
      orderUnit:"롤", orderQty:order.mat_roll, stock:stockState.mat, addQty:add.mat_roll,
      unitPrice: u.mat_per_m, needMoney:needAmt.mat, addMoney:addAmt.mat
    },
    {
      name:"홀더", needQty:need.holder_each, baseUnit:"개",
      orderUnit:"자루", orderQty:order.holder_bag, stock:stockState.holder, addQty:add.holder_bag,
      unitPrice: u.holder_per_each, needMoney:needAmt.holder, addMoney:addAmt.holder
    },
    {
      name:"팩", needQty:need.peg_each, baseUnit:"개",
      orderUnit:"자루", orderQty:order.peg_bag, stock:stockState.peg, addQty:add.peg_bag,
      unitPrice: u.peg_per_each, needMoney:needAmt.peg, addMoney:addAmt.peg
    },
    {
      name:"실리콘", needQty:need.silicone_each, baseUnit:"개",
      orderUnit:"박스", orderQty:order.silicone_box, stock:stockState.silicone, addQty:add.silicone_box,
      unitPrice: u.silicone_per_each, needMoney:needAmt.silicone, addMoney:addAmt.silicone
    },
    {
      name:"힐티가스", needQty:need.hiltiGas_can, baseUnit:"캔",
      orderUnit:"캔", orderQty:order.hiltiGas_can, stock:stockState.hiltiGas, addQty:add.hiltiGas_can,
      unitPrice: u.hiltiGas_per_can, needMoney:needAmt.hiltiGas, addMoney:addAmt.hiltiGas
    },
    {
      name:"힐티핀", needQty:need.hiltiPin_shot, baseUnit:"발",
      orderUnit:"통", orderQty:order.hiltiPin_tong, stock:stockState.hiltiPin, addQty:add.hiltiPin_tong,
      unitPrice: hiltiPin_per_shot, needMoney:needAmt.hiltiPin, addMoney:addAmt.hiltiPin
    }
  ];

  let sumNeed = 0, sumAdd = 0;
  rows.forEach(r=>{ sumNeed += r.needMoney; sumAdd += r.addMoney; });

  const thPrice = showPrices ? `<th class="price-col">단가(VAT)</th>` : ``;

  let html = `
  <table>
    <thead>
      <tr>
        <th>자재</th>
        <th>필요수량</th>
        <th>단위</th>
        <th>발주단위</th>
        <th>단위수량</th>
        <th>재고</th>
        <th>추가발주</th>
        ${thPrice}
        <th>필요금액</th>
        <th>추가발주금액</th>
      </tr>
    </thead>
    <tbody>
  `;

  for(const r of rows){
    html += `
      <tr>
        <td>${r.name}</td>
        <td class="money">${money(r.needQty.toFixed(0))}</td>
        <td>${r.baseUnit}</td>
        <td>${r.orderUnit}</td>
        <td class="money">${money(r.orderQty)}</td>
        <td class="money">${money(r.stock)}</td>
        <td class="money"><b>${money(r.addQty)}</b></td>
        ${showPrices ? `<td class="money price-col">${money(r.unitPrice.toFixed(3))}</td>` : ``}
        <td class="money">${money(Math.round(r.needMoney))}원</td>
        <td class="money"><b>${money(Math.round(r.addMoney))}원</b></td>
      </tr>
    `;
  }

  html += `
    </tbody>
    <tfoot>
      <tr>
        <td colspan="${showPrices ? 8 : 7}">합계</td>
        <td class="money">${money(Math.round(sumNeed))}원</td>
        <td class="money"><b>${money(Math.round(sumAdd))}원</b></td>
      </tr>
    </tfoot>
  </table>
  `;

  document.getElementById(targetId).innerHTML = html;
}

function recalc(){
  renderTable(1.00, "outFM");
  renderTable(1.05, "outFM5");
}

document.getElementById("btnCalc").addEventListener("click", recalc);

document.getElementById("btnReset").addEventListener("click", ()=>{
  cfg = structuredClone(DEFAULT_CFG);
  saveCfg(cfg);
  for(const k in stockState) stockState[k]=0;
  renderStockInputs();
  recalc();
  alert("기본값으로 복원했습니다.");
});

document.getElementById("btnPrint").addEventListener("click", ()=>{ recalc(); window.print(); });

document.getElementById("btnSaveImg").addEventListener("click", async ()=>{
  recalc();
  const target = document.getElementById("printArea");
  const canvas = await html2canvas(target, {backgroundColor:"#0b1220", scale:2});
  const a = document.createElement("a");
  a.download = `방초매트_보고용_${new Date().toISOString().slice(0,10)}.png`;
  a.href = canvas.toDataURL("image/png");
  a.click();
});

/** 관리자 설정(비번 1004) */
document.getElementById("btnAdmin").addEventListener("click", ()=>{
  const pw = prompt("관리자 비밀번호를 입력하세요:");
  if(pw !== FIRST_PASS){ alert("비밀번호가 올바르지 않습니다."); return; }

  document.body.classList.toggle("show-prices");

  const want = confirm("단가/포장/계수를 수정하시겠습니까?\n(취소: 단가 표시만 토글)");
  if(!want){ recalc(); return; }

  // 단가(기본단위 기준)
  const u = cfg.prices_base;

  const v1 = prompt(`[단가] 방초매트 (m당) 현재: ${u.mat_per_m}`); if(v1!==null && v1!=="") u.mat_per_m = Number(v1);
  const v2 = prompt(`[단가] 홀더 (개당) 현재: ${u.holder_per_each}`); if(v2!==null && v2!=="") u.holder_per_each = Number(v2);
  const v3 = prompt(`[단가] 팩 (개당) 현재: ${u.peg_per_each}`); if(v3!==null && v3!=="") u.peg_per_each = Number(v3);
  const v4 = prompt(`[단가] 실리콘 (개당) 현재: ${u.silicone_per_each}`); if(v4!==null && v4!=="") u.silicone_per_each = Number(v4);
  const v5 = prompt(`[단가] 힐티가스 (캔당) 현재: ${u.hiltiGas_per_can}`); if(v5!==null && v5!=="") u.hiltiGas_per_can = Number(v5);
  const v6 = prompt(`[단가] 힐티핀 (통당) 현재: ${u.hiltiPin_per_tong}`); if(v6!==null && v6!=="") u.hiltiPin_per_tong = Number(v6);

  // 포장수량
  const p = cfg.pack;
  const p1 = prompt(`[포장] 방초매트 1롤 = 몇 m? 현재: ${p.mat_m_per_roll}`); if(p1!==null && p1!=="") p.mat_m_per_roll = Number(p1);
  const p2 = prompt(`[포장] 홀더 1자루 = 몇 개? 현재: ${p.holder_each_per_bag}`); if(p2!==null && p2!=="") p.holder_each_per_bag = Number(p2);
  const p3 = prompt(`[포장] 팩 1자루 = 몇 개? 현재: ${p.peg_each_per_bag}`); if(p3!==null && p3!=="") p.peg_each_per_bag = Number(p3);
  const p4 = prompt(`[포장] 실리콘 1박스 = 몇 개? 현재: ${p.silicone_each_per_box}`); if(p4!==null && p4!=="") p.silicone_each_per_box = Number(p4);
  const p5 = prompt(`[포장] 힐티핀 1통 = 몇 발? 현재: ${p.hiltiPin_shot_per_tong}`); if(p5!==null && p5!=="") p.hiltiPin_shot_per_tong = Number(p5);

  // 계수(1m당 필요량)
  const r = cfg.rules;
  const r1 = prompt(`[계수] 방초매트(1m당 m) 현재: ${r.mat_m_per_m}`); if(r1!==null && r1!=="") r.mat_m_per_m = Number(r1);
  const r2 = prompt(`[계수] 홀더(1m당 개) 현재: ${r.holder_each_per_m}`); if(r2!==null && r2!=="") r.holder_each_per_m = Number(r2);
  const r3 = prompt(`[계수] 팩(1m당 개) 현재: ${r.peg_each_per_m}`); if(r3!==null && r3!=="") r.peg_each_per_m = Number(r3);
  const r4 = prompt(`[계수] 실리콘(1m당 개) 현재: ${r.silicone_each_per_m}`); if(r4!==null && r4!=="") r.silicone_each_per_m = Number(r4);
  const r5 = prompt(`[계수] 힐티가스(1m당 캔) 현재: ${r.hiltiGas_can_per_m}`); if(r5!==null && r5!=="") r.hiltiGas_can_per_m = Number(r5);
  const r6 = prompt(`[계수] 힐티핀(1m당 발) 현재: ${r.hiltiPin_shot_per_m}`); if(r6!==null && r6!=="") r.hiltiPin_shot_per_m = Number(r6);

  saveCfg(cfg);
  recalc();
  alert("저장 완료. (단가는 관리자 모드에서만 표시됩니다)");
});

/** PWA service worker */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

renderStockInputs();
recalc();
</script>
</body>
</html>
