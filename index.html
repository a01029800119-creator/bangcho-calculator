<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>방초매트 발주 계산기 (FM / FM+5%)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="icons/icon-192.png">

  <!-- html2canvas (이미지 저장) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --line:#213252;
      --text:#e8f0ff;
      --muted:#9bb0d1;
      --accent:#4aa3ff;
      --accent2:#7bd35a;
      --danger:#ff6b6b;
      --chip:#0f2448;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
    }
    a{color:var(--accent)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .title h1{font-size:22px;margin:0;letter-spacing:-.3px}
    .pill{
      display:inline-block;
      border:1px solid var(--line);
      background:var(--chip);
      color:var(--muted);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
    }
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:#0c1426;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{
      background:var(--accent);
      color:#061226;
      border-color:transparent;
    }
    .btn.ghost{
      background:transparent;
    }
    .btn.warn{
      background:#ffcc66;
      color:#2b2100;
      border-color:transparent;
    }
    .btn:active{transform:translateY(1px)}
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    label{display:block;color:var(--muted);font-size:13px;margin:8px 0 6px}
    input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0c1426;
      color:var(--text);
      font-size:15px;
      outline:none;
    }
    input::placeholder{color:#60739a}
    .note{
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
      margin-top:8px;
      white-space:pre-line;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      text-align:right;
      vertical-align:middle;
      white-space:nowrap;
    }
    th:first-child, td:first-child{text-align:left;white-space:normal}
    th{color:var(--muted);font-weight:700}
    tfoot td{font-weight:900}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .danger{color:var(--danger)}
    .hide{display:none !important}
    .subhead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:6px;
    }
    .subhead h2{margin:0;font-size:16px}
    .smallchip{
      border:1px solid var(--line);
      background:var(--chip);
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }

    /* 앱 잠금(최초1회 비번) */
    .lock{
      position:fixed; inset:0;
      background:rgba(11,18,32,.92);
      display:flex;align-items:center;justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .lock .box{
      max-width:460px;width:100%;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .lock h3{margin:0 0 6px;font-size:18px}
    .lock p{margin:0 0 10px;color:var(--muted);font-size:13px;line-height:1.45}
    .lock .row2{display:flex;gap:8px}
    .lock input{flex:1}
    .lock .msg{margin-top:8px;font-size:12px;color:var(--danger);min-height:16px}

    /* print */
    @media print{
      body{background:#fff;color:#000}
      .topbar, .no-print{display:none !important}
      .card{box-shadow:none;border:1px solid #ddd;background:#fff}
      th{color:#333}
      .muted{color:#555}
    }
  </style>
</head>

<body>

<!-- 앱 잠금(최초 1회) -->
<div id="lock" class="lock hide">
  <div class="box">
    <h3>방초매트 발주 계산기</h3>
    <p>실행 비밀번호가 필요합니다. (해당 기기에서 최초 1회만)</p>
    <div class="row2">
      <input id="lockPw" type="password" placeholder="비밀번호 입력">
      <button class="btn primary" onclick="unlock()">확인</button>
    </div>
    <div id="lockMsg" class="msg"></div>
  </div>
</div>

<div class="wrap" id="app">

  <div class="topbar no-print">
    <div class="title">
      <h1>방초매트 발주 계산기</h1>
      <span class="pill">FM · FM+5% 동시</span>
      <span class="pill">로그인 없음 / 단가·설정은 관리자 모드</span>
    </div>
    <div class="toolbar">
      <button class="btn" onclick="openAdmin()">관리자 설정</button>
      <button class="btn" onclick="printReport()">보고용 출력</button>
      <button class="btn" onclick="saveImage()">이미지 저장</button>
      <button class="btn ghost" onclick="resetAll()">기본값 복원</button>
    </div>
  </div>

  <!-- 입력 -->
  <div class="card">
    <div class="row">
      <div>
        <label>공사구간 (m)</label>
        <input id="len" type="number" inputmode="numeric" placeholder="예: 1300" value="1000">
        <div class="right" style="margin-top:10px;">
          <button class="btn primary" onclick="recalc()">계산</button>
        </div>
        <div class="note">
- 필요수량: 소수점 발생 시 올림(CEIL)
- 힐티핀: (발) 필요수량 → (통) 발주수량 = CEIL(발/1200)
- 단가는 기본 숨김(관리자 모드에서만 표시)
        </div>
      </div>

      <div>
        <div class="subhead">
          <div>
            <div class="muted" style="font-size:13px;margin-bottom:2px;">재고(발주단위) 입력</div>
            <div class="muted" style="font-size:12px;">(롤/자루/박스/캔/통 기준)</div>
          </div>
          <span id="adminBadge" class="smallchip hide">관리자 모드</span>
        </div>

        <div class="grid" style="grid-template-columns:1fr 1fr;">
          <div>
            <label>방초매트 (롤)</label>
            <input id="st_mat" type="number" value="0">
          </div>
          <div>
            <label>홀더 (자루)</label>
            <input id="st_holder" type="number" value="0">
          </div>
          <div>
            <label>팩 (자루)</label>
            <input id="st_pack" type="number" value="0">
          </div>
          <div>
            <label>실리콘 (박스)</label>
            <input id="st_silicon" type="number" value="0">
          </div>
          <div>
            <label>힐티가스 (캔)</label>
            <input id="st_gas" type="number" value="0">
          </div>
          <div>
            <label>힐티핀 (통)</label>
            <input id="st_pin" type="number" value="0">
          </div>
        </div>

        <div class="note">
* 재고는 “발주단위” 기준입니다.
        </div>
      </div>
    </div>
  </div>

  <!-- 관리자 패널 -->
  <div id="adminPanel" class="card hide no-print" style="margin-top:12px;">
    <div class="subhead">
      <h2>단가 설정 (관리자 전용)</h2>
      <span class="smallchip">비번 1004 · 최초 1회</span>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr;">
      <div>
        <label>방초매트 단가 (원 / m)</label>
        <input id="p_mat" type="number">
      </div>
      <div>
        <label>홀더 단가 (원 / 개)</label>
        <input id="p_holder" type="number">
      </div>
      <div>
        <label>팩 단가 (원 / 개)</label>
        <input id="p_pack" type="number">
      </div>
      <div>
        <label>실리콘 단가 (원 / 개)</label>
        <input id="p_silicon" type="number">
      </div>
      <div>
        <label>힐티가스 단가 (원 / 캔)</label>
        <input id="p_gas" type="number">
      </div>
      <div>
        <label>힐티핀 단가 (원 / 통)</label>
        <input id="p_pin" type="number">
      </div>
    </div>

    <div class="right" style="margin-top:10px;">
      <button class="btn primary" onclick="savePrices()">단가 저장</button>
      <button class="btn ghost" onclick="togglePriceVisibility()">단가 표시/숨김 토글</button>
    </div>

    <div class="note">
- 단가 저장은 이 기기(브라우저)에 저장됩니다(localStorage).
- 단가 표시 토글은 “관리자”만 사용 가능.
    </div>
  </div>

  <!-- 결과(이미지 저장 대상) -->
  <div id="reportArea" style="margin-top:12px;">
    <div class="grid">
      <div class="card">
        <div class="subhead">
          <h2>FM 결과</h2>
          <span class="smallchip">기준안</span>
        </div>
        <div class="muted" style="font-size:13px;">공사구간: <b id="lenOut1"></b> m</div>
        <div id="tbl_fm"></div>
      </div>

      <div class="card">
        <div class="subhead">
          <h2>FM+5% 결과</h2>
          <span class="smallchip">여유 +5%</span>
        </div>
        <div class="muted" style="font-size:13px;">공사구간: <b id="lenOut2"></b> m</div>
        <div id="tbl_fm5"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="subhead">
        <h2>요약</h2>
        <span class="smallchip">추가발주 기준 합계</span>
      </div>
      <div id="summary"></div>
    </div>
  </div>
</div>

<script>
/** =============================
 *  설정/데이터 (필요 시 여기만 수정)
 *  ============================= */
const APP_PASSWORD = "1004";        // 실행 비번(최초 1회)
const ADMIN_PASSWORD = "1004";      // 관리자 비번(최초 1회, 동일)
const LS_UNLOCK = "bangcho_unlocked";
const LS_ADMIN  = "bangcho_admin";
const LS_PRICES = "bangcho_prices";
const LS_SHOW_PRICE = "bangcho_show_price";

/**
 * 자재 정의
 * - perM: { fm, fm5 } : 1m당 필요수량(기준 단위)
 * - unit: 필요수량 단위 표기
 * - orderUnit: 발주단위 표기
 * - pack: 발주단위당 포함 수량 (필요수량 단위 기준)
 * - priceMode:
 *    "base"  : 필요금액 = 필요수량 * 단가
 *    "order" : 필요금액 = 발주단위수량 * 단가   (힐티핀)
 */
const ITEMS = [
  { key:"mat",     name:"방초매트", unit:"m",  orderUnit:"롤",  pack:50,   perM:{fm:1.00,  fm5:1.05}, priceMode:"base"  },
  { key:"holder",  name:"홀더",     unit:"개", orderUnit:"자루", pack:50,  perM:{fm:0.333, fm5:0.35}, priceMode:"base"  },
  { key:"pack",    name:"팩",       unit:"개", orderUnit:"자루", pack:500, perM:{fm:3.00,  fm5:3.15}, priceMode:"base"  },
  { key:"silicon", name:"실리콘",   unit:"개", orderUnit:"박스", pack:25,  perM:{fm:0.20,  fm5:0.21}, priceMode:"base"  },
  { key:"gas",     name:"힐티가스", unit:"캔", orderUnit:"캔",   pack:1,   perM:{fm:0.004, fm5:0.004}, priceMode:"base"  },
  // 힐티핀: 필요수량(발) → 발주단위(통=1200발), 단가는 통 기준
  { key:"pin",     name:"힐티핀",   unit:"발", orderUnit:"통",   pack:1200,perM:{fm:4.00,  fm5:4.20}, priceMode:"order" }
];

// 기본 단가 (관리자에서 수정 가능)
const DEFAULT_PRICES = {
  mat: 3960,       // 원 / m
  holder: 715,     // 원 / 개
  pack: 330,       // 원 / 개
  silicon: 1700,   // 원 / 개
  gas: 80850,      // 원 / 캔
  pin: 51150       // 원 / 통
};

/** =============================
 *  유틸
 *  ============================= */
const ceil = (x) => Math.ceil(Number(x || 0));
const money = (n) => (Number(n || 0)).toLocaleString("ko-KR") + "원";
const num = (n) => (Number(n || 0)).toLocaleString("ko-KR");

function loadPrices(){
  const saved = localStorage.getItem(LS_PRICES);
  if(!saved) return {...DEFAULT_PRICES};
  try{
    const obj = JSON.parse(saved);
    return { ...DEFAULT_PRICES, ...obj };
  }catch(e){
    return {...DEFAULT_PRICES};
  }
}

function getStocks(){
  return {
    mat: ceil(document.getElementById("st_mat").value),
    holder: ceil(document.getElementById("st_holder").value),
    pack: ceil(document.getElementById("st_pack").value),
    silicon: ceil(document.getElementById("st_silicon").value),
    gas: ceil(document.getElementById("st_gas").value),
    pin: ceil(document.getElementById("st_pin").value),
  };
}

/** =============================
 *  잠금/관리자
 *  ============================= */
function initLock(){
  const unlocked = localStorage.getItem(LS_UNLOCK) === "1";
  if(!unlocked){
    document.getElementById("lock").classList.remove("hide");
    document.getElementById("lockPw").value = "";
  }
}
function unlock(){
  const v = (document.getElementById("lockPw").value || "").trim();
  if(v === APP_PASSWORD){
    localStorage.setItem(LS_UNLOCK, "1");
    document.getElementById("lock").classList.add("hide");
    document.getElementById("lockMsg").textContent = "";
  }else{
    document.getElementById("lockMsg").textContent = "비밀번호가 올바르지 않습니다.";
  }
}

function isAdmin(){
  return localStorage.getItem(LS_ADMIN) === "1";
}
function openAdmin(){
  if(isAdmin()){
    toggleAdminPanel(true);
    return;
  }
  const input = prompt("관리자 비밀번호(최초 1회):");
  if((input||"").trim() === ADMIN_PASSWORD){
    localStorage.setItem(LS_ADMIN, "1");
    toggleAdminPanel(true);
    alert("관리자 모드가 활성화되었습니다. (이 기기에서 최초 1회)");
  }else{
    alert("비밀번호 오류");
  }
}
function toggleAdminPanel(on){
  const panel = document.getElementById("adminPanel");
  const badge = document.getElementById("adminBadge");
  if(on){
    panel.classList.remove("hide");
    badge.classList.remove("hide");
    // 관리자 패널 값 채우기
    const p = loadPrices();
    document.getElementById("p_mat").value = p.mat;
    document.getElementById("p_holder").value = p.holder;
    document.getElementById("p_pack").value = p.pack;
    document.getElementById("p_silicon").value = p.silicon;
    document.getElementById("p_gas").value = p.gas;
    document.getElementById("p_pin").value = p.pin;
    recalc();
  }else{
    panel.classList.add("hide");
    badge.classList.add("hide");
    recalc();
  }
}
function savePrices(){
  if(!isAdmin()){
    alert("관리자 모드가 아닙니다.");
    return;
  }
  const prices = {
    mat: ceil(document.getElementById("p_mat").value),
    holder: ceil(document.getElementById("p_holder").value),
    pack: ceil(document.getElementById("p_pack").value),
    silicon: ceil(document.getElementById("p_silicon").value),
    gas: ceil(document.getElementById("p_gas").value),
    pin: ceil(document.getElementById("p_pin").value),
  };
  localStorage.setItem(LS_PRICES, JSON.stringify(prices));
  alert("단가 저장 완료");
  recalc();
}

// 단가 표시/숨김 (B)
function showPrice(){
  // 기본: 숨김. 관리자일 때만 토글 허용.
  const s = localStorage.getItem(LS_SHOW_PRICE);
  return (isAdmin() && s === "1");
}
function togglePriceVisibility(){
  if(!isAdmin()){
    alert("관리자만 변경 가능합니다.");
    return;
  }
  const now = localStorage.getItem(LS_SHOW_PRICE) === "1";
  localStorage.setItem(LS_SHOW_PRICE, now ? "0" : "1");
  recalc();
}

/** =============================
 *  계산 로직
 *  ============================= */
function compute(mode, length, prices, stocks){
  // mode: "fm" | "fm5"
  const rows = [];
  let sumNeed = 0;
  let sumAdd = 0;

  for(const it of ITEMS){
    const per = it.perM[mode];
    let needQty = ceil(length * per);                 // 필요수량(기준단위)
    const orderUnits = ceil(needQty / it.pack);       // 발주단위 수량(올림)
    const stockUnits = ceil(stocks[it.key] || 0);     // 재고(발주단위)
    const addUnits = Math.max(0, orderUnits - stockUnits);

    // 금액
    let needAmount = 0;
    let addAmount = 0;

    if(it.priceMode === "order"){
      // 힐티핀: 단가(통) * 발주수량(통)
      needAmount = orderUnits * prices[it.key];
      addAmount  = addUnits   * prices[it.key];
    }else{
      // 일반: 단가(기준단위) * 필요수량(기준단위)
      needAmount = needQty * prices[it.key];
      // 추가발주금액 = 추가발주(발주단위) * (pack*단가)
      addAmount  = addUnits * it.pack * prices[it.key];
    }

    sumNeed += needAmount;
    sumAdd  += addAmount;

    rows.push({
      name: it.name,
      needQty,
      unit: it.unit,
      orderUnits,
      orderUnit: it.orderUnit,
      stockUnits,
      addUnits,
      price: prices[it.key],
      needAmount,
      addAmount
    });
  }

  return { rows, sumNeed, sumAdd };
}

function renderTable(targetId, result){
  const priceVisible = showPrice();

  let html = `
    <table>
      <thead>
        <tr>
          <th>자재</th>
          <th>필요수량</th>
          <th>단위</th>
          <th>발주단위수량</th>
          <th>단위</th>
          <th>재고(발주단위)</th>
          <th>추가발주(발주단위)</th>
          <th class="${priceVisible ? "" : "hide"}">단가(VAT)</th>
          <th>필요금액</th>
          <th>추가발주금액</th>
        </tr>
      </thead>
      <tbody>
  `;

  for(const r of result.rows){
    html += `
      <tr>
        <td>${r.name}</td>
        <td>${num(r.needQty)}</td>
        <td>${r.unit}</td>
        <td>${num(r.orderUnits)}</td>
        <td>${r.orderUnit}</td>
        <td>${num(r.stockUnits)}</td>
        <td><b>${num(r.addUnits)}</b></td>
        <td class="${priceVisible ? "" : "hide"}">${priceVisible ? money(r.price) : ""}</td>
        <td>${money(r.needAmount)}</td>
        <td><b>${money(r.addAmount)}</b></td>
      </tr>
    `;
  }

  html += `
      </tbody>
      <tfoot>
        <tr>
          <td>합계</td>
          <td colspan="${priceVisible ? 7 : 6}"></td>
          ${priceVisible ? `<td></td>` : ``}
          <td>${money(result.sumNeed)}</td>
          <td>${money(result.sumAdd)}</td>
        </tr>
      </tfoot>
    </table>
  `;

  document.getElementById(targetId).innerHTML = html;
}

function recalc(){
  const length = ceil(document.getElementById("len").value);
  document.getElementById("lenOut1").textContent = num(length);
  document.getElementById("lenOut2").textContent = num(length);

  const prices = loadPrices();
  const stocks = getStocks();

  const fm  = compute("fm",  length, prices, stocks);
  const fm5 = compute("fm5", length, prices, stocks);

  renderTable("tbl_fm", fm);
  renderTable("tbl_fm5", fm5);

  // 요약
  const sumHtml = `
    <table>
      <thead>
        <tr>
          <th></th>
          <th>FM</th>
          <th>FM+5%</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>필요금액 합계</td>
          <td>${money(fm.sumNeed)}</td>
          <td>${money(fm5.sumNeed)}</td>
        </tr>
        <tr>
          <td><b>추가발주 금액 합계</b></td>
          <td><b>${money(fm.sumAdd)}</b></td>
          <td><b>${money(fm5.sumAdd)}</b></td>
        </tr>
      </tbody>
    </table>
    <div class="note">
* 추가발주 금액 = (발주단위 수량 - 재고) 기준으로 계산됩니다.
    </div>
  `;
  document.getElementById("summary").innerHTML = sumHtml;
}

/** =============================
 *  출력/이미지 저장
 *  ============================= */
function printReport(){
  // 단가 숨김(B) 유지. 관리자여도 토글 OFF면 단가 안 나옴.
  window.print();
}

async function saveImage(){
  const area = document.getElementById("reportArea");
  const canvas = await html2canvas(area, {backgroundColor: "#0b1220", scale: 2});
  const link = document.createElement("a");
  link.download = "bangcho-report.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}

/** =============================
 *  초기화
 *  ============================= */
function resetAll(){
  if(!confirm("이 기기 저장값(단가/관리자/잠금/단가표시)을 초기화할까요?")) return;

  localStorage.removeItem(LS_UNLOCK);
  localStorage.removeItem(LS_ADMIN);
  localStorage.removeItem(LS_PRICES);
  localStorage.removeItem(LS_SHOW_PRICE);

  // 재고/길이 초기화(원하시면 수정)
  document.getElementById("len").value = 1000;
  document.getElementById("st_mat").value = 0;
  document.getElementById("st_holder").value = 0;
  document.getElementById("st_pack").value = 0;
  document.getElementById("st_silicon").value = 0;
  document.getElementById("st_gas").value = 0;
  document.getElementById("st_pin").value = 0;

  toggleAdminPanel(false);
  initLock();
  recalc();
}

// 첫 로드
window.addEventListener("load", () => {
  initLock();
  if(isAdmin()) toggleAdminPanel(true);
  recalc();
});
</script>

</body>
</html>
