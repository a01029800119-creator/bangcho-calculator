<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë°©ì´ˆë§¤íŠ¸ ë°œì£¼ ê³„ì‚°ê¸° (FM / FM+5%)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="icons/icon-192.png">

  <!-- html2canvas (ì´ë¯¸ì§€ ì €ì¥) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --line:#213252;
      --text:#e8f0ff;
      --muted:#9bb0d1;
      --accent:#44a3ff;
      --accent2:#7bd35a;
      --danger:#ff6b6b;
      --chip:#0f2448;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--accent)}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:12px;object-fit:contain;background:#fff;
      border:1px solid rgba(255,255,255,.08);
    }
    .title h1{font-size:20px;margin:0;letter-spacing:-.2px}
    .title .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid rgba(255,255,255,.08);color:var(--muted);font-size:12px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .card h2{margin:0 0 8px;font-size:14px;color:var(--muted);font-weight:700}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 820px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:#0c1426;color:var(--text);font-size:15px;outline:none;
    }
    input:focus{border-color:rgba(68,163,255,.65);box-shadow:0 0 0 3px rgba(68,163,255,.18)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    button{
      border:1px solid var(--line);background:#0c1426;color:var(--text);
      padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700
    }
    button.primary{background:var(--accent);border-color:transparent;color:#041022}
    button.ghost{background:transparent}
    button.warn{background:var(--danger);border-color:transparent;color:#260606}
    button:active{transform:translateY(1px)}

    .note{font-size:12px;color:var(--muted);line-height:1.45}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:9px 8px;text-align:right;font-size:13px}
    th:first-child,td:first-child{text-align:left}
    thead th{color:var(--muted);font-weight:800}
    tfoot td{font-weight:900}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .muted{color:var(--muted)}
    .hide{display:none !important}

    /* ì¸ì‡„ ìµœì í™” */
    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:none}
      .card{border:1px solid #ddd;background:#fff}
      .pill,.toolbar,#adminPanel,#lockOverlay{display:none !important}
      table th,table td{border-bottom:1px solid #ddd}
    }

    /* ì ê¸ˆ ì˜¤ë²„ë ˆì´ */
    #lockOverlay{
      position:fixed;inset:0;background:rgba(6,10,18,.85);
      display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999;
    }
    .lockBox{
      width:min(420px,100%);background:var(--card);border:1px solid var(--line);
      border-radius:14px;padding:16px
    }
    .lockBox h3{margin:0 0 6px;font-size:16px}
    .lockBox p{margin:0 0 10px;color:var(--muted);font-size:12px;line-height:1.45}
    .lockRow{display:flex;gap:8px}
    .lockRow input{flex:1}
  </style>
</head>

<body>
  <!-- ìµœì´ˆ 1íšŒ ì‹¤í–‰ ì ê¸ˆ -->
  <div id="lockOverlay" class="hide">
    <div class="lockBox">
      <h3>ë°©ì´ˆë§¤íŠ¸ ë°œì£¼ ê³„ì‚°ê¸° ğŸ”’</h3>
      <p>ìµœì´ˆ 1íšŒ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì´ ê¸°ê¸°ì—ì„œë§Œ ì €ì¥ë©ë‹ˆë‹¤)</p>
      <div class="lockRow">
        <input id="lockPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" inputmode="numeric" />
        <button class="primary" id="unlockBtn">í™•ì¸</button>
      </div>
      <p id="lockMsg" class="note" style="margin-top:8px;color:var(--danger)"></p>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img class="logo" id="logoImg" src="logo.png" alt="SIWON GRID" onerror="this.style.display='none'">
        <div class="title">
          <h1>ë°©ì´ˆë§¤íŠ¸ ë°œì£¼ ê³„ì‚°ê¸° <span class="pill">FM Â· FM+5% ë™ì‹œ</span></h1>
          <div class="sub">ë¡œê·¸ì¸ ì—†ì´ ì‚¬ìš©. ë‹¨ê°€/ì„¤ì •ì€ ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div style="flex:1"></div>
      <div class="right">
        <button id="adminBtn" class="ghost">ê´€ë¦¬ì ì„¤ì •</button>
        <button id="printBtn" class="ghost">ë³´ê³ ìš© ì¶œë ¥</button>
        <button id="saveImgBtn" class="ghost">ì´ë¯¸ì§€ ì €ì¥</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>ê³µì‚¬êµ¬ê°„ (m)</label>
          <input id="len" type="number" min="0" step="1" value="1000" />
          <div class="toolbar">
            <button class="primary" id="calcBtn">ê³„ì‚°</button>
            <button id="resetBtn">ê¸°ë³¸ê°’ ë³µì›</button>
          </div>
          <div class="note" style="margin-top:10px">
            Â· íí‹°í•€: CEIL(ì˜¬ë¦¼) Â· íí‹°ê°€ìŠ¤: CEIL(í•€/1200) ê¸°ì¤€<br>
            Â· ë°œì£¼ë‹¨ìœ„ ìˆ˜ëŸ‰ì€ í¬ì¥ë‹¨ìœ„ë¡œ ì˜¬ë¦¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div>
          <label>ì¬ê³ (í¬ì¥ë‹¨ìœ„) ì…ë ¥</label>
          <div class="row">
            <div>
              <label class="muted">ë°©ì´ˆë§¤íŠ¸(ë¡¤)</label>
              <input id="st_mat_roll" type="number" min="0" step="1" value="0"/>
            </div>
            <div>
              <label class="muted">í™€ë”(ìë£¨)</label>
              <input id="st_holder_pack" type="number" min="0" step="1" value="0"/>
            </div>
          </div>
          <div class="row">
            <div>
              <label class="muted">íŒ©(ìë£¨)</label>
              <input id="st_pack_pack" type="number" min="0" step="1" value="0"/>
            </div>
            <div>
              <label class="muted">ì‹¤ë¦¬ì½˜(ë°•ìŠ¤)</label>
              <input id="st_sil_box" type="number" min="0" step="1" value="0"/>
            </div>
          </div>
          <div class="row">
            <div>
              <label class="muted">íí‹°ê°€ìŠ¤(ìº”)</label>
              <input id="st_gas_can" type="number" min="0" step="1" value="0"/>
            </div>
            <div>
              <label class="muted">íí‹°í•€(í†µ)</label>
              <input id="st_pin_tong" type="number" min="0" step="1" value="0"/>
            </div>
          </div>
          <div class="note" style="margin-top:6px">
            * ì¬ê³ ëŠ” â€œí¬ì¥ë‹¨ìœ„(ë¡¤/ìë£¨/ë°•ìŠ¤/ìº”/í†µ)â€ ê¸°ì¤€ì…ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>

    <!-- ê²°ê³¼ ìº¡ì²˜ ì˜ì—­ -->
    <div id="reportArea" class="grid2" style="margin-top:12px">
      <div class="card">
        <h2>FM ê²°ê³¼</h2>
        <div id="fmTable"></div>
      </div>
      <div class="card">
        <h2>FM+5% ê²°ê³¼</h2>
        <div id="fm5Table"></div>
      </div>
    </div>

    <!-- ê´€ë¦¬ì íŒ¨ë„ -->
    <div id="adminPanel" class="card hide" style="margin-top:12px">
      <h2>ê´€ë¦¬ì ì„¤ì • (ë‹¨ê°€/ê¸°ì¤€ ìˆ˜ì •)</h2>
      <div class="note">Â· ë‹¨ê°€/ê¸°ì¤€ì€ ì´ ê¸°ê¸°(ë¸Œë¼ìš°ì €)ì— ì €ì¥ë©ë‹ˆë‹¤. (localStorage)</div>

      <div class="row" style="margin-top:8px">
        <div class="card" style="padding:12px">
          <h2 style="margin:0 0 8px">1më‹¹ ì†Œìš”ëŸ‰(ê¸°ì¤€)</h2>
          <div class="row">
            <div>
              <label>í™€ë” (FM)</label>
              <input id="cfg_holder_fm" type="number" step="0.001">
            </div>
            <div>
              <label>í™€ë” (FM+5)</label>
              <input id="cfg_holder_fm5" type="number" step="0.001">
            </div>
          </div>
          <div class="row">
            <div>
              <label>íŒ© (FM)</label>
              <input id="cfg_pack_fm" type="number" step="0.001">
            </div>
            <div>
              <label>íŒ© (FM+5)</label>
              <input id="cfg_pack_fm5" type="number" step="0.001">
            </div>
          </div>
          <div class="row">
            <div>
              <label>ì‹¤ë¦¬ì½˜ (FM)</label>
              <input id="cfg_sil_fm" type="number" step="0.001">
            </div>
            <div>
              <label>ì‹¤ë¦¬ì½˜ (FM+5)</label>
              <input id="cfg_sil_fm5" type="number" step="0.001">
            </div>
          </div>
          <div class="row">
            <div>
              <label>íí‹°í•€(ë°œ) (FM)</label>
              <input id="cfg_pin_fm" type="number" step="0.001">
            </div>
            <div>
              <label>íí‹°í•€(ë°œ) (FM+5)</label>
              <input id="cfg_pin_fm5" type="number" step="0.001">
            </div>
          </div>
        </div>

        <div class="card" style="padding:12px">
          <h2 style="margin:0 0 8px">í¬ì¥ë‹¨ìœ„ / ë‹¨ê°€(VAT í¬í•¨)</h2>
          <div class="row">
            <div>
              <label>ë°©ì´ˆë§¤íŠ¸ í¬ì¥ë‹¨ìœ„ (m/ë¡¤)</label>
              <input id="cfg_mat_per_roll" type="number" step="1">
            </div>
            <div>
              <label>ë°©ì´ˆë§¤íŠ¸ ë‹¨ê°€ (ì›/m)</label>
              <input id="cfg_price_mat" type="number" step="1">
            </div>
          </div>

          <div class="row">
            <div>
              <label>í™€ë” í¬ì¥ë‹¨ìœ„ (ê°œ/ìë£¨)</label>
              <input id="cfg_holder_per_pack" type="number" step="1">
            </div>
            <div>
              <label>í™€ë” ë‹¨ê°€ (ì›/ê°œ)</label>
              <input id="cfg_price_holder" type="number" step="1">
            </div>
          </div>

          <div class="row">
            <div>
              <label>íŒ© í¬ì¥ë‹¨ìœ„ (ê°œ/ìë£¨)</label>
              <input id="cfg_pack_per_pack" type="number" step="1">
            </div>
            <div>
              <label>íŒ© ë‹¨ê°€ (ì›/ê°œ)</label>
              <input id="cfg_price_pack" type="number" step="1">
            </div>
          </div>

          <div class="row">
            <div>
              <label>ì‹¤ë¦¬ì½˜ í¬ì¥ë‹¨ìœ„ (ê°œ/ë°•ìŠ¤)</label>
              <input id="cfg_sil_per_box" type="number" step="1">
            </div>
            <div>
              <label>ì‹¤ë¦¬ì½˜ ë‹¨ê°€ (ì›/ê°œ)</label>
              <input id="cfg_price_sil" type="number" step="1">
            </div>
          </div>

          <div class="row">
            <div>
              <label>íí‹°í•€ í¬ì¥ë‹¨ìœ„ (ë°œ/í†µ)</label>
              <input id="cfg_pin_per_tong" type="number" step="1">
            </div>
            <div>
              <label>íí‹°í•€ ë‹¨ê°€ (ì›/í†µ)</label>
              <input id="cfg_price_pin_tong" type="number" step="1">
            </div>
          </div>

          <div class="row">
            <div>
              <label>íí‹°ê°€ìŠ¤ ë‹¨ê°€ (ì›/ìº”)</label>
              <input id="cfg_price_gas_can" type="number" step="1">
            </div>
            <div class="note" style="align-self:end">
              * ê°€ìŠ¤ëŠ” â€œí•€ 1,200ë°œë‹¹ 1ìº”â€ìœ¼ë¡œ ìë™ ì‚°ì¶œ
            </div>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <button class="primary" id="saveCfgBtn">ì„¤ì • ì €ì¥</button>
        <button id="closeAdminBtn">ë‹«ê¸°</button>
        <button class="warn" id="factoryBtn">ê³µì¥ì´ˆê¸°í™”(ì„¤ì •ì‚­ì œ)</button>
      </div>
    </div>
  </div>

<script>
/** ========== ë³´ì•ˆ/ì ê¸ˆ(ìµœì´ˆ1íšŒ) ========== */
const LOCK_KEY = "bangcho_first_unlock_ok";
const PASS_DEFAULT = "1004";

function ensureFirstUnlock(){
  const ok = localStorage.getItem(LOCK_KEY);
  const overlay = document.getElementById("lockOverlay");
  if(ok === "1"){
    overlay.classList.add("hide");
    return;
  }
  overlay.classList.remove("hide");

  const pw = document.getElementById("lockPw");
  const msg = document.getElementById("lockMsg");
  const btn = document.getElementById("unlockBtn");

  const tryUnlock = () => {
    if(String(pw.value||"") === PASS_DEFAULT){
      localStorage.setItem(LOCK_KEY,"1");
      overlay.classList.add("hide");
      msg.textContent = "";
      pw.value = "";
      recalc();
    }else{
      msg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤.";
    }
  };
  btn.onclick = tryUnlock;
  pw.onkeydown = (e)=>{ if(e.key==="Enter") tryUnlock(); };
}

/** ========== ê¸°ë³¸ ì„¤ì •(ê´€ë¦¬ìì—ì„œë§Œ ë‹¨ê°€/ìˆ˜ì • ë…¸ì¶œ) ========== */
const CFG_KEY = "bangcho_cfg_v2";
const DEFAULT = {
  // 1më‹¹ ì†Œìš”ëŸ‰(ê¸°ì¤€)
  rates: {
    FM:  { holder:0.333, pack:3.000, sil:0.200, pin:4.000 },
    FM5: { holder:0.350, pack:3.150, sil:0.210, pin:4.200 },
  },
  // í¬ì¥ë‹¨ìœ„
  packSize: {
    mat_m_per_roll: 50,
    holder_per_pack: 50,
    pack_per_pack: 500,
    sil_per_box: 25,
    pin_per_tong: 1200
  },
  // ë‹¨ê°€(VAT í¬í•¨) (ê´€ë¦¬ìì—ì„œë§Œ ë³´ì´ì§€ë§Œ ê³„ì‚°ì—ëŠ” ì‚¬ìš©)
  price: {
    mat_per_m: 3960,        // 3,600 + VAT
    holder_each: 715,       // 650 + VAT
    pack_each: 330,         // 300 + VAT
    sil_each: 1700,         // ì´ë¯¸ VAT í¬í•¨
    gas_can: 80850,         // 73,500 + VAT
    pin_tong: 51150         // 46,500 + VAT (1,200ë°œ)
  }
};

function loadCfg(){
  try{
    const raw = localStorage.getItem(CFG_KEY);
    if(!raw) return structuredClone(DEFAULT);
    const obj = JSON.parse(raw);
    // merge safe
    return {
      rates: {
        FM:  { ...DEFAULT.rates.FM,  ...(obj.rates?.FM||{}) },
        FM5: { ...DEFAULT.rates.FM5, ...(obj.rates?.FM5||{}) },
      },
      packSize: { ...DEFAULT.packSize, ...(obj.packSize||{}) },
      price: { ...DEFAULT.price, ...(obj.price||{}) }
    };
  }catch{
    return structuredClone(DEFAULT);
  }
}
function saveCfg(cfg){
  localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
}

/** ========== ê³„ì‚° ìœ í‹¸ ========== */
const ceil = (x)=> Math.ceil(Number(x||0));
const n = (x)=> Number(x||0);
const money = (x)=> (Math.round(n(x)*100)/100).toLocaleString("ko-KR"); // ì†Œìˆ˜ ë°˜ì˜¬ë¦¼(í‘œì‹œìš©)
const money0 = (x)=> Math.round(n(x)).toLocaleString("ko-KR");

function getStocks(){
  return {
    mat_roll: ceil(document.getElementById("st_mat_roll").value),
    holder_pack: ceil(document.getElementById("st_holder_pack").value),
    pack_pack: ceil(document.getElementById("st_pack_pack").value),
    sil_box: ceil(document.getElementById("st_sil_box").value),
    gas_can: ceil(document.getElementById("st_gas_can").value),
    pin_tong: ceil(document.getElementById("st_pin_tong").value),
  };
}

function compute(mode, L, cfg, st){
  const r = (mode==="FM") ? cfg.rates.FM : cfg.rates.FM5;

  // í•„ìš”ìˆ˜ëŸ‰(ì˜¬ë¦¼/ì •ìˆ˜)
  const need_mat_m = ceil(L); // ë°©ì´ˆë§¤íŠ¸ mëŠ” ê·¸ëŒ€ë¡œ
  const need_holder_each = ceil(L * r.holder);
  const need_pack_each = ceil(L * r.pack);
  const need_sil_each = ceil(L * r.sil);

  // íí‹°í•€(ë°œ): CEIL
  const need_pin_each = ceil(L * r.pin);

  // íí‹°ê°€ìŠ¤(ìº”): CEIL(í•€/1200)  â† ì°¨ì¥ë‹˜ í™”ë©´ê³¼ ë™ì¼ ë°©ì‹
  const need_gas_can = ceil(need_pin_each / cfg.packSize.pin_per_tong);

  // í¬ì¥ë‹¨ìœ„ í™˜ì‚°(ì˜¬ë¦¼)
  const ord_mat_roll = ceil(need_mat_m / cfg.packSize.mat_m_per_roll);
  const ord_holder_pack = ceil(need_holder_each / cfg.packSize.holder_per_pack);
  const ord_pack_pack = ceil(need_pack_each / cfg.packSize.pack_per_pack);
  const ord_sil_box = ceil(need_sil_each / cfg.packSize.sil_per_box);
  const ord_gas_can = need_gas_can; // ì´ë¯¸ 'ìº”' ë‹¨ìœ„
  const ord_pin_tong = ceil(need_pin_each / cfg.packSize.pin_per_tong);

  // ì¶”ê°€ë°œì£¼(ì¬ê³  ì°¨ê°)
  const add_mat_roll = Math.max(0, ord_mat_roll - st.mat_roll);
  const add_holder_pack = Math.max(0, ord_holder_pack - st.holder_pack);
  const add_pack_pack = Math.max(0, ord_pack_pack - st.pack_pack);
  const add_sil_box = Math.max(0, ord_sil_box - st.sil_box);
  const add_gas_can = Math.max(0, ord_gas_can - st.gas_can);
  const add_pin_tong = Math.max(0, ord_pin_tong - st.pin_tong);

  // ê¸ˆì•¡(ë‹¨ê°€ ìˆ¨ê¹€: í™”ë©´í‘œì‹œë§Œ ìˆ¨ê¹€, ê³„ì‚°ì€ ìˆ˜í–‰)
  const amt_need_mat = need_mat_m * cfg.price.mat_per_m;
  const amt_need_holder = need_holder_each * cfg.price.holder_each;
  const amt_need_pack = need_pack_each * cfg.price.pack_each;
  const amt_need_sil = need_sil_each * cfg.price.sil_each;
  const amt_need_gas = need_gas_can * cfg.price.gas_can;
  const amt_need_pin = ord_pin_tong * cfg.price.pin_tong; // í†µ ë‹¨ê°€

  const amt_add_mat = add_mat_roll * (cfg.packSize.mat_m_per_roll * cfg.price.mat_per_m);
  const amt_add_holder = add_holder_pack * (cfg.packSize.holder_per_pack * cfg.price.holder_each);
  const amt_add_pack = add_pack_pack * (cfg.packSize.pack_per_pack * cfg.price.pack_each);
  const amt_add_sil = add_sil_box * (cfg.packSize.sil_per_box * cfg.price.sil_each);
  const amt_add_gas = add_gas_can * cfg.price.gas_can;
  const amt_add_pin = add_pin_tong * cfg.price.pin_tong;

  const sumNeed = amt_need_mat + amt_need_holder + amt_need_pack + amt_need_sil + amt_need_gas + amt_need_pin;
  const sumAdd = amt_add_mat + amt_add_holder + amt_add_pack + amt_add_sil + amt_add_gas + amt_add_pin;

  const rows = [
    {
      name:"ë°©ì´ˆë§¤íŠ¸", need:need_mat_m, unit:"m",
      order:ord_mat_roll, orderUnit:"ë¡¤", stock:st.mat_roll, add:add_mat_roll,
      priceType:"m", price:cfg.price.mat_per_m,
      needAmt:amt_need_mat, addAmt:amt_add_mat
    },
    {
      name:"í™€ë”", need:need_holder_each, unit:"ê°œ",
      order:ord_holder_pack, orderUnit:"ìë£¨", stock:st.holder_pack, add:add_holder_pack,
      priceType:"ê°œ", price:cfg.price.holder_each,
      needAmt:amt_need_holder, addAmt:amt_add_holder
    },
    {
      name:"íŒ©", need:need_pack_each, unit:"ê°œ",
      order:ord_pack_pack, orderUnit:"ìë£¨", stock:st.pack_pack, add:add_pack_pack,
      priceType:"ê°œ", price:cfg.price.pack_each,
      needAmt:amt_need_pack, addAmt:amt_add_pack
    },
    {
      name:"ì‹¤ë¦¬ì½˜", need:need_sil_each, unit:"ê°œ",
      order:ord_sil_box, orderUnit:"ë°•ìŠ¤", stock:st.sil_box, add:add_sil_box,
      priceType:"ê°œ", price:cfg.price.sil_each,
      needAmt:amt_need_sil, addAmt:amt_add_sil
    },
    {
      name:"íí‹°ê°€ìŠ¤", need:need_gas_can, unit:"ìº”",
      order:ord_gas_can, orderUnit:"ìº”", stock:st.gas_can, add:add_gas_can,
      priceType:"ìº”", price:cfg.price.gas_can,
      needAmt:amt_need_gas, addAmt:amt_add_gas
    },
    {
      name:"íí‹°í•€", need:need_pin_each, unit:"ë°œ",
      order:ord_pin_tong, orderUnit:"í†µ", stock:st.pin_tong, add:add_pin_tong,
      priceType:"í†µ", price:cfg.price.pin_tong,
      needAmt:amt_need_pin, addAmt:amt_add_pin
    },
  ];

  return { rows, sumNeed, sumAdd };
}

function renderTable(targetId, result, showPrices){
  const el = document.getElementById(targetId);
  const priceCol = showPrices ? `
    <th>ë‹¨ê°€(VAT)</th>
  ` : ``;

  const head = `
    <table>
      <thead>
        <tr>
          <th>ìì¬</th>
          <th>í•„ìš”ìˆ˜ëŸ‰</th>
          <th>ë‹¨ìœ„</th>
          <th>ë°œì£¼ë‹¨ìœ„</th>
          <th>ë‹¨ìœ„</th>
          <th>ì¬ê³ </th>
          <th>ì¶”ê°€ë°œì£¼</th>
          ${priceCol}
          <th>í•„ìš”ê¸ˆì•¡</th>
          <th>ì¶”ê°€ë°œì£¼ê¸ˆì•¡</th>
        </tr>
      </thead>
      <tbody>
  `;

  const body = result.rows.map(r=>{
    const priceTd = showPrices ? `<td>${money0(r.price)}ì›/${r.priceType}</td>` : ``;
    return `
      <tr>
        <td>${r.name}</td>
        <td>${money0(r.need)}</td>
        <td>${r.unit}</td>
        <td>${money0(r.order)}</td>
        <td>${r.orderUnit}</td>
        <td>${money0(r.stock)}</td>
        <td><b>${money0(r.add)}</b></td>
        ${priceTd}
        <td>${money(r.needAmt)}ì›</td>
        <td><b>${money(r.addAmt)}ì›</b></td>
      </tr>
    `;
  }).join("");

  const foot = `
      </tbody>
      <tfoot>
        <tr>
          <td colspan="${showPrices?8:7}">í•©ê³„</td>
          <td>${money(result.sumNeed)}ì›</td>
          <td>${money(result.sumAdd)}ì›</td>
        </tr>
      </tfoot>
    </table>
  `;

  el.innerHTML = head + body + foot;
}

/** ========== ê´€ë¦¬ì UI ========== */
let cfg = loadCfg();

function fillAdminForm(){
  // rates
  document.getElementById("cfg_holder_fm").value = cfg.rates.FM.holder;
  document.getElementById("cfg_holder_fm5").value = cfg.rates.FM5.holder;
  document.getElementById("cfg_pack_fm").value = cfg.rates.FM.pack;
  document.getElementById("cfg_pack_fm5").value = cfg.rates.FM5.pack;
  document.getElementById("cfg_sil_fm").value = cfg.rates.FM.sil;
  document.getElementById("cfg_sil_fm5").value = cfg.rates.FM5.sil;
  document.getElementById("cfg_pin_fm").value = cfg.rates.FM.pin;
  document.getElementById("cfg_pin_fm5").value = cfg.rates.FM5.pin;

  // pack size
  document.getElementById("cfg_mat_per_roll").value = cfg.packSize.mat_m_per_roll;
  document.getElementById("cfg_holder_per_pack").value = cfg.packSize.holder_per_pack;
  document.getElementById("cfg_pack_per_pack").value = cfg.packSize.pack_per_pack;
  document.getElementById("cfg_sil_per_box").value = cfg.packSize.sil_per_box;
  document.getElementById("cfg_pin_per_tong").value = cfg.packSize.pin_per_tong;

  // prices
  document.getElementById("cfg_price_mat").value = cfg.price.mat_per_m;
  document.getElementById("cfg_price_holder").value = cfg.price.holder_each;
  document.getElementById("cfg_price_pack").value = cfg.price.pack_each;
  document.getElementById("cfg_price_sil").value = cfg.price.sil_each;
  document.getElementById("cfg_price_gas_can").value = cfg.price.gas_can;
  document.getElementById("cfg_price_pin_tong").value = cfg.price.pin_tong;
}

function readAdminForm(){
  cfg.rates.FM.holder = n(document.getElementById("cfg_holder_fm").value);
  cfg.rates.FM5.holder = n(document.getElementById("cfg_holder_fm5").value);
  cfg.rates.FM.pack = n(document.getElementById("cfg_pack_fm").value);
  cfg.rates.FM5.pack = n(document.getElementById("cfg_pack_fm5").value);
  cfg.rates.FM.sil = n(document.getElementById("cfg_sil_fm").value);
  cfg.rates.FM5.sil = n(document.getElementById("cfg_sil_fm5").value);
  cfg.rates.FM.pin = n(document.getElementById("cfg_pin_fm").value);
  cfg.rates.FM5.pin = n(document.getElementById("cfg_pin_fm5").value);

  cfg.packSize.mat_m_per_roll = ceil(document.getElementById("cfg_mat_per_roll").value);
  cfg.packSize.holder_per_pack = ceil(document.getElementById("cfg_holder_per_pack").value);
  cfg.packSize.pack_per_pack = ceil(document.getElementById("cfg_pack_per_pack").value);
  cfg.packSize.sil_per_box = ceil(document.getElementById("cfg_sil_per_box").value);
  cfg.packSize.pin_per_tong = ceil(document.getElementById("cfg_pin_per_tong").value);

  cfg.price.mat_per_m = n(document.getElementById("cfg_price_mat").value);
  cfg.price.holder_each = n(document.getElementById("cfg_price_holder").value);
  cfg.price.pack_each = n(document.getElementById("cfg_price_pack").value);
  cfg.price.sil_each = n(document.getElementById("cfg_price_sil").value);
  cfg.price.gas_can = n(document.getElementById("cfg_price_gas_can").value);
  cfg.price.pin_tong = n(document.getElementById("cfg_price_pin_tong").value);
}

/** ========== ê³„ì‚° ì‹¤í–‰ ========== */
function recalc(){
  const L = ceil(document.getElementById("len").value);
  const st = getStocks();

  const fm = compute("FM", L, cfg, st);
  const fm5 = compute("FM5", L, cfg, st);

  // ë‹¨ê°€ ìˆ¨ê¹€(B): ê´€ë¦¬ì íŒ¨ë„ ì—´ë ¸ì„ ë•Œë§Œ ë‹¨ê°€ ë³´ì´ê²Œ
  const adminOpen = !document.getElementById("adminPanel").classList.contains("hide");
  renderTable("fmTable", fm, adminOpen);
  renderTable("fm5Table", fm5, adminOpen);
}

function resetInputs(){
  document.getElementById("len").value = 1000;

  document.getElementById("st_mat_roll").value = 0;
  document.getElementById("st_holder_pack").value = 0;
  document.getElementById("st_pack_pack").value = 0;
  document.getElementById("st_sil_box").value = 0;
  document.getElementById("st_gas_can").value = 0;
  document.getElementById("st_pin_tong").value = 0;

  recalc();
}

/** ========== ë³´ê³ /ì´ë¯¸ì§€ ì €ì¥ ========== */
async function saveReportImage(){
  const area = document.getElementById("reportArea");
  const canvas = await html2canvas(area, { backgroundColor: "#0b1220", scale: 2 });
  const link = document.createElement("a");
  const L = ceil(document.getElementById("len").value);
  link.download = `ë°©ì´ˆë§¤íŠ¸_ë°œì£¼ì‚°ì¶œ_${L}m.png`;
  link.href = canvas.toDataURL("image/png");
  link.click();
}

/** ========== ì´ë²¤íŠ¸ ë°”ì¸ë”© ========== */
document.getElementById("calcBtn").onclick = recalc;
document.getElementById("resetBtn").onclick = resetInputs;

document.getElementById("printBtn").onclick = ()=> window.print();
document.getElementById("saveImgBtn").onclick = saveReportImage;

// ì…ë ¥ ë³€ê²½ì‹œ ìë™ ê³„ì‚°(ê°€ë³ê²Œ)
["len","st_mat_roll","st_holder_pack","st_pack_pack","st_sil_box","st_gas_can","st_pin_tong"].forEach(id=>{
  document.getElementById(id).addEventListener("input", ()=>recalc());
});

document.getElementById("adminBtn").onclick = ()=>{
  const p = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(ê¸°ë³¸ 1004):");
  if(String(p||"") !== PASS_DEFAULT){
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤.");
    return;
  }
  const panel = document.getElementById("adminPanel");
  panel.classList.toggle("hide");
  fillAdminForm();
  recalc();
};
document.getElementById("closeAdminBtn").onclick = ()=>{
  document.getElementById("adminPanel").classList.add("hide");
  recalc();
};
document.getElementById("saveCfgBtn").onclick = ()=>{
  readAdminForm();
  saveCfg(cfg);
  alert("ì„¤ì • ì €ì¥ ì™„ë£Œ");
  recalc();
};
document.getElementById("factoryBtn").onclick = ()=>{
  if(!confirm("ì„¤ì •ì„ ì „ë¶€ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
  localStorage.removeItem(CFG_KEY);
  cfg = loadCfg();
  fillAdminForm();
  alert("ì´ˆê¸°í™” ì™„ë£Œ");
  recalc();
};

window.addEventListener("load", ()=>{
  ensureFirstUnlock();
  fillAdminForm();
  recalc();
});
</script>

</body>
</html>
