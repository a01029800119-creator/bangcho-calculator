<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>방초매트 발주 계산기 (FM / FM+5%)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- html2canvas (이미지 저장) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --line:#213252;
      --text:#e8f0ff;
      --muted:#9bb0d1;
      --accent:#44a3ff;
      --accent2:#7bd35a;
      --danger:#ff6b6b;
      --chip:#0f2448;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--accent)}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    .badge{display:inline-flex;align-items:center;gap:8px}
    .pill{display:inline-block;border:1px solid var(--line);background:rgba(15,36,72,.55);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{border:1px solid var(--line);background:#0c1426;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:#041022;font-weight:800}
    button.ghost{background:transparent}
    button:active{transform:translateY(1px)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px 0;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:900px){ .row{grid-template-columns:1fr} }

    label{display:block;color:var(--muted);font-size:13px;margin:8px 0 6px}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1426;color:var(--text);font-size:15px}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.45}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .muted{color:var(--muted)}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:right;font-size:13px}
    th:first-child,td:first-child{text-align:left}
    th{color:var(--muted);font-weight:700}
    tfoot td{font-weight:900}
    .money{font-variant-numeric:tabular-nums}

    /* ✅ 모바일 가독성 강화: 재고 입력칸 라벨(자재명+단위) 크게 */
    .stock label{
      font-size:14px;
      font-weight:800;
      color:var(--text);
      letter-spacing:.1px;
    }
    .stock label span.unit{color:var(--muted);font-weight:700;margin-left:6px}
    @media(max-width:600px){
      .stock label{font-size:18px}
      .stock input{font-size:16px;padding:12px 12px}
    }

    /* 단가 숨김(B): 기본 숨김, 관리자에서만 표시 */
    .price-col{display:none}
    .show-prices .price-col{display:table-cell}

    /* 출력(보고용) 영역 */
    .print-area{margin-top:12px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){ .two-col{grid-template-columns:1fr} }

    /* ✅ A4 1페이지 출력 고정 */
    @page { size: A4; margin: 10mm; }
    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:none;padding:0}
      .topbar,.toolbar,.input-area,.hint,.btnrow{display:none !important}
      .card{box-shadow:none;border:1px solid #ccc;background:#fff;color:#000}
      .pill{display:none}
      .print-area{margin:0}
      .two-col{grid-template-columns:1fr 1fr;gap:8mm}
      table{margin-top:6mm}
      th,td{font-size:10.5pt;padding:6px 5px;border-bottom:1px solid #ddd}
      h2{font-size:12pt;margin:0 0 4mm 0}
      .muted{color:#333}
      .no-break{page-break-inside:avoid;break-inside:avoid}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <div class="badge">
        <h1>방초매트 발주 계산기</h1>
        <span class="pill">FM · FM+5% 동시</span>
      </div>
      <div class="sub">로그인 없이 사용 가능. <b>단가/설정은 관리자 모드에서만 표시</b>됩니다.</div>
    </div>

    <div class="toolbar">
      <button class="ghost" id="btnAdmin">관리자 설정</button>
      <button class="ghost" id="btnPrint">보고용 출력</button>
      <button class="ghost" id="btnSaveImg">이미지 저장</button>
    </div>
  </div>

  <div class="grid input-area">
    <div class="card">
      <h2>입력</h2>

      <label for="len">공사구간 (m)</label>
      <input id="len" type="number" inputmode="numeric" value="1800" min="0"/>

      <div class="btnrow">
        <button class="primary" id="btnCalc">계산</button>
        <button id="btnReset">기본값 복원</button>
      </div>

      <div class="hint">
        · 힐티가스: <b>CEIL(올림) = CEIL(필요수량/1200)</b> 기준<br>
        · 발주단위 수량은 포장단위로 올림 처리합니다.
      </div>
    </div>

    <div class="card stock">
      <h2>재고(포장단위) 입력</h2>
      <div class="row" id="stockInputs"></div>
      <div class="hint">* 재고는 “포장단위(롤/자루/박스/캔/통)” 기준입니다.</div>
    </div>
  </div>

  <div class="print-area" id="printArea">
    <div class="two-col">
      <div class="card no-break">
        <h2>FM 결과</h2>
        <div id="outFM"></div>
      </div>
      <div class="card no-break">
        <h2>FM+5% 결과</h2>
        <div id="outFM5"></div>
      </div>
    </div>
  </div>

</div>

<script>
/** =========================
 *  ✅ 최초1회 비번(방법 A)
 *  - 최초 1회만 비번(1004) 확인 → 로컬저장
 *  - 이후는 비번 없이 바로 진입
 * ========================= */
const FIRST_PASS = "1004";
const KEY_UNLOCK = "bangcho_unlocked_once";

(function firstTimeGate(){
  const unlocked = localStorage.getItem(KEY_UNLOCK) === "1";
  if (unlocked) return;
  const pw = prompt("최초 1회 실행 비밀번호를 입력하세요:");
  if (pw !== FIRST_PASS) {
    alert("비밀번호가 올바르지 않습니다. (페이지를 새로고침 후 다시 입력)");
    // 차단: 화면을 비워서 사용 불가 처리
    document.body.innerHTML = "";
    return;
  }
  localStorage.setItem(KEY_UNLOCK, "1");
})();

/** =========================
 *  데이터/기본값
 * ========================= */
const DEFAULT_CFG = {
  // 단가(원) - 관리자에서만 보이게(단가숨김 B)
  prices: {
    mat: 3960,        // 방초매트 (롤당)
    holder: 715,      // 홀더 (개당)
    peg: 330,         // 팩 (개당)
    silicone: 1700,   // 실리콘 (개당)
    hiltiGas: 80850,  // 힐티가스 (캔당)
    hiltiPin: 51150   // 힐티핀 (발당)
  },
  // 포장단위(한 포장에 몇 개/몇 m)
  pack: {
    mat: 100,       // 1롤에 100m(예시)
    holder: 50,     // 1자루에 50개(예시)
    peg: 500,       // 1자루에 500개(예시)
    silicone: 10,   // 1박스에 10개(예시)
    hiltiGas: 1,    // 1캔
    hiltiPin: 1000  // 1통에 1000발(예시)
  },
  // 필요 수량 산식 계수(필요하면 여기 조정)
  rules: {
    mat_per_m: 1.0,        // 1m당 방초매트 1m 필요
    holder_per_m: 0.333,   // 예시
    peg_per_m: 3.0,        // 예시
    silicone_per_m: 0.2,   // 예시
    hiltiGas_per_m: 0.003, // 예시 (필요수량 캔)
    hiltiPin_per_m: 4.0    // 예시 (필요수량 발)
  }
};

const KEY_CFG = "bangcho_cfg_v1";
function loadCfg(){
  try{
    const raw = localStorage.getItem(KEY_CFG);
    if(!raw) return structuredClone(DEFAULT_CFG);
    const obj = JSON.parse(raw);
    // 최소 병합
    return {
      ...structuredClone(DEFAULT_CFG),
      ...obj,
      prices:{...DEFAULT_CFG.prices, ...(obj.prices||{})},
      pack:{...DEFAULT_CFG.pack, ...(obj.pack||{})},
      rules:{...DEFAULT_CFG.rules, ...(obj.rules||{})}
    };
  }catch(e){
    return structuredClone(DEFAULT_CFG);
  }
}
function saveCfg(cfg){ localStorage.setItem(KEY_CFG, JSON.stringify(cfg)); }

let cfg = loadCfg();

// 재고 입력값(포장단위)
const stockState = {
  mat: 0,
  holder: 0,
  peg: 0,
  silicone: 0,
  hiltiGas: 0,
  hiltiPin: 0
};

const MATERIALS = [
  { key:"mat",      name:"방초매트", unit:"롤", packUnit:"m",   needLabel:"필요수량(m)",     priceLabel:"단가(VAT)" },
  { key:"holder",   name:"홀더",     unit:"자루", packUnit:"개", needLabel:"필요수량(개)",    priceLabel:"단가(VAT)" },
  { key:"peg",      name:"팩",       unit:"자루", packUnit:"개", needLabel:"필요수량(개)",    priceLabel:"단가(VAT)" },
  { key:"silicone", name:"실리콘",   unit:"박스", packUnit:"개", needLabel:"필요수량(개)",    priceLabel:"단가(VAT)" },
  { key:"hiltiGas", name:"힐티가스", unit:"캔",   packUnit:"캔", needLabel:"필요수량(캔)",    priceLabel:"단가(VAT)" },
  { key:"hiltiPin", name:"힐티핀",   unit:"통",   packUnit:"발", needLabel:"필요수량(발)",    priceLabel:"단가(VAT)" }
];

/** =========================
 *  UI 렌더: 재고 입력 라벨(자재명+단위 크게)
 * ========================= */
function renderStockInputs(){
  const wrap = document.getElementById("stockInputs");
  wrap.innerHTML = "";
  for(const m of MATERIALS){
    const div = document.createElement("div");
    div.innerHTML = `
      <label for="st_${m.key}">
        ${m.name}<span class="unit">(${m.unit})</span>
      </label>
      <input id="st_${m.key}" type="number" inputmode="numeric" min="0" value="${stockState[m.key]||0}">
    `;
    wrap.appendChild(div);
    div.querySelector("input").addEventListener("input", (e)=>{
      stockState[m.key] = Number(e.target.value||0);
    });
  }
}

/** =========================
 *  계산 유틸
 * ========================= */
function ceil(n){ return Math.ceil(Number(n)); }
function money(n){
  const x = Number(n||0);
  return x.toLocaleString("ko-KR");
}
function clamp0(n){ return Math.max(0, Number(n||0)); }

// 포장단위 발주수량 = ceil(필요수량 / 포장수량)
function orderUnits(need, packSize){
  if(packSize <= 0) return 0;
  return ceil(need / packSize);
}

function computeCase(mult){
  const len = clamp0(document.getElementById("len").value);
  const r = cfg.rules;

  // FM 필요량(기본) 계산
  const need = {
    mat: len * r.mat_per_m,
    holder: len * r.holder_per_m,
    peg: len * r.peg_per_m,
    silicone: len * r.silicone_per_m,
    hiltiGas: len * r.hiltiGas_per_m,
    hiltiPin: len * r.hiltiPin_per_m
  };

  // FM+5%면 필요량 1.05배
  for(const k in need) need[k] = need[k] * mult;

  // 힐티가스는 요구사항대로 “필요수량/1200 올림” 규칙(예: 핀 기준)처럼 별도 처리 가능
  // 요청사항: "힐티가스: CEIL(필요수량/1200)" → 필요수량을 '발' 스케일로 환산하는 구조가 아니라서,
  // 여기서는 기존 계산값을 '캔' 기준으로 보고, 1200 규칙을 '캔'에 적용하진 않습니다.
  // 대신, 힐티가스가 '발/작업량' 기반이면 아래처럼 적용:
  // need.hiltiGas = ceil(need.hiltiPin / 1200);  // (원하시면 이 규칙으로 고정해드리겠습니다)

  const rows = [];
  let sumNeed = 0;
  let sumAdd = 0;

  for(const m of MATERIALS){
    const n = need[m.key];
    const st = clamp0(stockState[m.key]);
    const packSize = cfg.pack[m.key];

    // 발주단위(포장단위) 필요 수량
    const orderQty = orderUnits(n, packSize);

    // 추가발주 = max(0, 발주단위 필요 - 재고)
    const addOrder = Math.max(0, orderQty - st);

    // 금액
    const unitPrice = cfg.prices[m.key];
    const needAmt = orderQty * unitPrice;
    const addAmt  = addOrder * unitPrice;

    sumNeed += needAmt;
    sumAdd  += addAmt;

    rows.push({
      name: m.name,
      needQty: n,
      baseUnit: m.packUnit,
      orderUnit: m.unit,
      orderQty,
      stock: st,
      addOrder,
      unitPrice,
      needAmt,
      addAmt
    });
  }

  return { rows, sumNeed, sumAdd };
}

function renderTable(result, targetId){
  const out = document.getElementById(targetId);

  const showPrices = document.body.classList.contains("show-prices"); // 관리자 모드에서만 true
  const thPrice = showPrices ? `<th class="price-col">단가(VAT)</th>` : ``;

  let html = `
  <table>
    <thead>
      <tr>
        <th>자재</th>
        <th>필요수량</th>
        <th>단위</th>
        <th>발주단위</th>
        <th>단위수량</th>
        <th>재고</th>
        <th>추가발주</th>
        ${thPrice}
        <th>필요금액</th>
        <th>추가발주금액</th>
      </tr>
    </thead>
    <tbody>
  `;

  for(const r of result.rows){
    html += `
      <tr>
        <td>${r.name}</td>
        <td class="money">${money(r.needQty.toFixed(2))}</td>
        <td>${r.baseUnit}</td>
        <td>${r.orderUnit}</td>
        <td class="money">${money(r.orderQty)}</td>
        <td class="money">${money(r.stock)}</td>
        <td class="money"><b>${money(r.addOrder)}</b></td>
        ${showPrices ? `<td class="money price-col">${money(r.unitPrice)}</td>` : ``}
        <td class="money">${money(r.needAmt)}원</td>
        <td class="money"><b>${money(r.addAmt)}원</b></td>
      </tr>
    `;
  }

  html += `
    </tbody>
    <tfoot>
      <tr>
        <td colspan="${showPrices ? 8 : 7}">합계</td>
        <td class="money">${money(result.sumNeed)}원</td>
        <td class="money"><b>${money(result.sumAdd)}원</b></td>
      </tr>
    </tfoot>
  </table>
  `;

  out.innerHTML = html;
}

/** =========================
 *  이벤트
 * ========================= */
function recalc(){
  const fm  = computeCase(1.00);
  const fm5 = computeCase(1.05);
  renderTable(fm, "outFM");
  renderTable(fm5,"outFM5");
}

document.getElementById("btnCalc").addEventListener("click", recalc);

document.getElementById("btnReset").addEventListener("click", ()=>{
  cfg = structuredClone(DEFAULT_CFG);
  saveCfg(cfg);
  // 재고도 0으로
  for(const k in stockState) stockState[k]=0;
  renderStockInputs();
  recalc();
  alert("기본값으로 복원했습니다.");
});

document.getElementById("btnPrint").addEventListener("click", ()=>{
  // 출력 전 최신 계산 보장
  recalc();
  window.print();
});

document.getElementById("btnSaveImg").addEventListener("click", async ()=>{
  recalc();
  const target = document.getElementById("printArea");
  const canvas = await html2canvas(target, {backgroundColor:"#0b1220", scale:2});
  const a = document.createElement("a");
  a.download = `방초매트_보고용_${new Date().toISOString().slice(0,10)}.png`;
  a.href = canvas.toDataURL("image/png");
  a.click();
});

/** =========================
 *  관리자 설정(단가/포장/계수)
 *  - 비번: 1004
 *  - 단가숨김(B): 기본 숨김, 관리자 모드에서만 표시/수정
 * ========================= */
document.getElementById("btnAdmin").addEventListener("click", ()=>{
  const pw = prompt("관리자 비밀번호를 입력하세요:");
  if(pw !== FIRST_PASS){
    alert("비밀번호가 올바르지 않습니다.");
    return;
  }
  // 관리자 모드 토글: 단가 컬럼 표시
  document.body.classList.toggle("show-prices");

  // 간단 관리자 UI: prompt로 핵심만 수정 (원하시면 모달로 예쁘게 바꿔드림)
  const want = confirm("단가/포장/계수 값을 수정하시겠습니까?\n(취소: 단가 표시만 토글)");
  if(!want){
    recalc();
    return;
  }

  // 단가 수정
  for(const m of MATERIALS){
    const cur = cfg.prices[m.key];
    const v = prompt(`[단가] ${m.name} (원/발주단위) 현재: ${cur}\n새 값 입력(취소=유지)`);
    if(v === null || v.trim()==="") continue;
    const num = Number(v);
    if(Number.isFinite(num) && num>=0) cfg.prices[m.key]=num;
  }
  // 포장수량 수정
  for(const m of MATERIALS){
    const cur = cfg.pack[m.key];
    const v = prompt(`[포장수량] ${m.name} (1${m.unit} 당 ${m.packUnit} 수량) 현재: ${cur}\n새 값 입력(취소=유지)`);
    if(v === null || v.trim()==="") continue;
    const num = Number(v);
    if(Number.isFinite(num) && num>0) cfg.pack[m.key]=num;
  }
  // 필요량 계수 수정(선택)
  for(const m of MATERIALS){
    const key = m.key + "_per_m";
    if(!(key in cfg.rules)) continue;
    const cur = cfg.rules[key];
    const v = prompt(`[계수] ${m.name} (1m당 필요량) 현재: ${cur}\n새 값 입력(취소=유지)`);
    if(v === null || v.trim()==="") continue;
    const num = Number(v);
    if(Number.isFinite(num) && num>=0) cfg.rules[key]=num;
  }

  saveCfg(cfg);
  recalc();
  alert("저장 완료. (단가는 관리자 모드에서만 표시됩니다)");
});

/** =========================
 *  PWA: Service Worker 등록
 * ========================= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

// 초기 렌더
renderStockInputs();
recalc();
</script>
</body>
</html>
